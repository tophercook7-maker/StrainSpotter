import{j as e,r as c,R as kr,S as V,B as o,I as qe,y as Xe,T as m,i as _,P as Pe,n as Ae,C as Cr,a2 as Ir,aa as Tr,A as Rr,ab as De,D as Pr,p as Ar,q as Dr,u as Lr}from"./react-vendor-CxfKVgr3.js";import{S as zr,n as Qe,t as Br}from"./ScanResultCard-Cv4hIP62.js";import{u as Fr}from"./useCanScan-Cd4tphRX.js";import{u as Er,b as Ur,c as Or,a as ir}from"./App-JmJcCWdD.js";import{u as Wr}from"./useCreditBalance-DnPtH5jr.js";import"./vendor-DCH4KwNm.js";import"./useStrainImage-pCt_md2M.js";function be(n){return n==null||Number.isNaN(Number(n))?"â€”":`${(typeof n=="string"?parseFloat(n):n).toFixed(2)}%`}function Ze(n){if(!n)return"â€”";const r=new Date(n);return Number.isNaN(r.getTime())?n:r.toLocaleDateString()}function O({label:n,value:r}){return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:1},children:[e.jsx("span",{style:{fontSize:11,opacity:.7},children:n}),e.jsx("span",{style:{fontSize:13},children:r!=null&&r!==""?r:"â€”"})]})}function Le({summary:n}){if(!n)return null;const{isPackagedProduct:r,matchConfidence:f,matchedStrainName:A,estimateConfidenceLabel:L,estimateType:b,notes:y,scanType:w="bud",stabilityScore:ne=1,stabilityLabel:C="single-frame",numberOfFrames:D=1,label:N={}}=n,{productName:K,brandName:q,packageType:ae,packageSize:H,thcPercent:te,cbdPercent:se,thcaPercent:le,batchId:ce,lotNumber:de,harvestDate:B,testDate:ue,labName:F,licenseNumber:G,originType:W}=N,Y=L||(f!=null?`${Math.round(f<=1?f*100:f)}% match`:"Unknown"),U=b||(r?"visual+label":"visual-only"),z=r||!!(K||q||te!=null||se!=null||le!=null);return e.jsxs("div",{style:{marginTop:16,marginBottom:16,padding:16,borderRadius:24,background:"linear-gradient(145deg, rgba(5,20,10,0.96), rgba(5,35,15,0.96))",color:"#f5fff5",backdropFilter:"blur(12px)"},children:[e.jsxs("div",{style:{marginBottom:12,display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{textTransform:"uppercase",fontSize:11,letterSpacing:1.2,opacity:.7},children:"AI scan summary"}),e.jsxs("div",{style:{fontSize:14,opacity:.8},children:[Y,f!=null&&e.jsxs(e.Fragment,{children:[" ","â€¢"," ",Math.round(f<=1?f*100:f),"%"]})]}),e.jsxs("div",{style:{fontSize:11,opacity:.7,marginTop:4,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsxs("span",{children:["Scan type: ",w==="package"?"Packaged product":w==="bud"?"Loose flower":"Live plant"]}),D>1&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[D,"-angle scan"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Stability: ",C==="high"?"High":C==="medium"?"Medium":"Low",C==="low"&&" (angles disagree, consider rescanning)",C==="medium"&&" (angles partly agree)"]})]}),D===1&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:"Single-frame scan. Add more angles in future updates for higher stability."})]})]})]}),A&&e.jsxs("div",{style:{fontSize:13,padding:"4px 10px",borderRadius:999,border:"1px solid rgba(180,255,190,0.3)",textAlign:"right"},children:["Closest match: ",e.jsx("strong",{children:A})]})]}),w==="package"&&e.jsxs("div",{style:{marginBottom:16,padding:12,borderRadius:16,background:"linear-gradient(135deg, rgba(40,80,30,0.9), rgba(15,40,20,0.95))",border:"1px solid rgba(200,255,200,0.18)",fontSize:13,lineHeight:1.4},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.7,marginBottom:4},children:"Packaged product detected"}),e.jsx("div",{children:"This scan looks like a packaged retail product. THC/CBD and label details were read and combined with visual features."})]}),w==="bud"&&!r&&e.jsxs("div",{style:{marginBottom:16,padding:12,borderRadius:16,background:"linear-gradient(135deg, rgba(30,60,25,0.9), rgba(10,30,15,0.95))",border:"1px solid rgba(180,240,180,0.18)",fontSize:13,lineHeight:1.4},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.7,marginBottom:4},children:"Loose flower detected"}),e.jsx("div",{children:"This looks like loose flower. The estimate is based mostly on visual structure (buds, trichomes, coloration)."})]}),w==="plant"&&e.jsxs("div",{style:{marginBottom:16,padding:12,borderRadius:16,background:"linear-gradient(135deg, rgba(25,50,20,0.9), rgba(8,25,12,0.95))",border:"1px solid rgba(160,220,160,0.18)",fontSize:13,lineHeight:1.4},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.7,marginBottom:4},children:"Live plant detected"}),e.jsx("div",{children:"This appears to be a live plant shot. Estimates for live plants are usually less precise than packaged/bud scans."})]}),z&&e.jsxs("div",{style:{marginBottom:18},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.7,marginBottom:6},children:"Label decode"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(0, 1fr) minmax(0, 1fr)",gap:8,fontSize:13},children:[e.jsx(O,{label:"Product name",value:K}),e.jsx(O,{label:"Brand",value:q}),e.jsx(O,{label:"Package type",value:ae||(r?"Packaged product":"â€”")}),e.jsx(O,{label:"Package size",value:H}),e.jsx(O,{label:"THC on label",value:be(te)}),e.jsx(O,{label:"CBD on label",value:be(se)}),e.jsx(O,{label:"THCA on label",value:be(le)}),e.jsx(O,{label:"Batch / Lot",value:ce||de}),e.jsx(O,{label:"Harvest date",value:Ze(B)}),e.jsx(O,{label:"Test date",value:Ze(ue)}),e.jsx(O,{label:"Lab",value:F}),e.jsx(O,{label:"License #",value:G})]})]}),e.jsxs("div",{style:{marginBottom:18},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.7,marginBottom:6},children:"How this estimate was made"}),e.jsxs("p",{style:{fontSize:13,lineHeight:1.5,margin:0,opacity:.9},children:[U==="visual+label"&&e.jsx(e.Fragment,{children:"This estimate combines what the AI sees in the plant/packaging (color, structure, visual features) with text decoded from the label (THC/CBD numbers, brand, product name)."}),U==="label-only"&&e.jsx(e.Fragment,{children:"This estimate relies mainly on the label text (THC/CBD numbers, product name, brand). Visual features had little or no impact."}),U==="visual-only"&&e.jsx(e.Fragment,{children:"No reliable label text was found. This estimate is based mainly on visual features and should be treated as an educated guess."})]}),D>1&&e.jsxs("p",{style:{fontSize:13,lineHeight:1.5,marginTop:8,opacity:.85},children:[C==="high"&&e.jsx(e.Fragment,{children:"Results were consistent across multiple angles of the same product."}),C==="medium"&&e.jsx(e.Fragment,{children:"Results were mostly consistent across angles, with some variation."}),C==="low"&&e.jsx(e.Fragment,{children:"Different angles gave conflicting signals. Consider rescanning with clearer shots of the bud/label."})]}),y&&e.jsx("p",{style:{fontSize:13,lineHeight:1.5,marginTop:8,opacity:.85},children:y})]}),e.jsxs("div",{style:{marginBottom:14,padding:12,borderRadius:16,background:"rgba(10, 40, 15, 0.9)",border:"1px solid rgba(130, 220, 150, 0.35)"},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.8,marginBottom:4},children:"For dispensaries"}),e.jsxs("ul",{style:{paddingLeft:16,margin:0,fontSize:13,lineHeight:1.45},children:[e.jsxs("li",{children:["Use the ",e.jsx("strong",{children:"THC/CBD on label"})," values above to verify they match your menu and label requirements."]}),q&&e.jsxs("li",{children:["Confirm this product is listed under"," ",e.jsx("strong",{children:q})," in your POS / menu system."]}),G&&e.jsxs("li",{children:["Check that license ",e.jsx("strong",{children:G})," is valid for the product's origin."]}),ce||de?e.jsxs("li",{children:["Record batch/lot ID ",e.jsx("strong",{children:ce||de})," for traceability and recall audits."]}):e.jsxs("li",{children:["Consider recording ",e.jsx("strong",{children:"batch / lot ID"})," for traceability, if present on the physical label."]}),r?e.jsxs("li",{children:["This scan looks like a ",e.jsx("strong",{children:"ready-for-sale package"}),". Use it to support intake checks and compliance reviews."]}):e.jsxs("li",{children:["This scan does ",e.jsx("strong",{children:"not"})," look like a full retail package. Treat this as a visual estimate only, not a compliance check."]})]})]}),e.jsxs("div",{style:{padding:12,borderRadius:16,background:"rgba(5, 35, 15, 0.9)",border:"1px solid rgba(110, 200, 140, 0.3)"},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1,opacity:.8,marginBottom:4},children:"For growers"}),e.jsxs("ul",{style:{paddingLeft:16,margin:0,fontSize:13,lineHeight:1.45},children:[A?e.jsxs("li",{children:["Visual / label features are closest to"," ",e.jsx("strong",{children:A}),". Use this as a reference when tracking phenotype consistency across batches."]}):e.jsx("li",{children:"Use this estimate as a starting point when comparing phenotypes or dialing in new genetics."}),te!=null&&e.jsxs("li",{children:["Label THC: ",e.jsx("strong",{children:be(te)}),". Compare this to your historical averages for this strain or batch."]}),le!=null&&e.jsxs("li",{children:["Label THCA: ",e.jsx("strong",{children:be(le)}),". Use this alongside THC and CBD to track decarb and curing results."]}),W&&e.jsxs("li",{children:["Origin detected as: ",e.jsx("strong",{children:W}),". Keep this consistent between your internal records and packaging."]}),e.jsxs("li",{children:["Future versions of StrainSpotter can add"," ",e.jsx("strong",{children:"terpene profiles"})," and grow notes once lab data is linked to this product."]})]})]})]})}function er(n){return n?Array.isArray(n)?n.map(r=>{if(typeof r=="string")return r.trim();if(r&&typeof r=="object"){if("name"in r&&"percent"in r){const f=typeof r.percent=="number"?Math.round(r.percent):r.percent;if(r.name&&f!=null&&f!=="")return`${r.name} (${f}%)`;if(r.name)return String(r.name)}if("name"in r&&r.name)return String(r.name);if("label"in r&&r.label)return String(r.label);if("value"in r&&r.value)return String(r.value)}return null}).filter(Boolean):[]:[]}function Mr({matchedStrain:n,scan:r}){if(!n)return null;const f=n.name||"Unknown strain",A=_r(n.type),L=tr(n.thc),b=tr(n.cbd),y=n.effects||null,w=n.flavors||null,ne=ar(y),C=ar(w),D=er(ne),N=er(C),K=n.lineage||"",q=r?.created_at||r?.createdAt||null;return e.jsxs("div",{style:{marginTop:"1.25rem",marginBottom:"0.5rem",padding:"1.1rem 1.0rem",borderRadius:"1rem",border:"1px solid rgba(76, 175, 80, 0.55)",background:"radial-gradient(circle at 0% 0%, rgba(178,255,89,0.18), transparent 60%), linear-gradient(145deg, rgba(5,10,5,0.98), rgba(16,30,16,0.98))",color:"#e8ffe1",boxShadow:"0 16px 40px rgba(0,0,0,0.55)",fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif'},children:[e.jsxs("div",{style:{display:"flex",gap:"0.75rem",alignItems:"flex-start",justifyContent:"space-between",marginBottom:"0.75rem"},children:[e.jsxs("div",{style:{minWidth:0,flex:1},children:[e.jsx("div",{style:{fontSize:"0.78rem",textTransform:"uppercase",letterSpacing:"0.12em",opacity:.75,marginBottom:"0.15rem"},children:"Scan result"}),e.jsx("div",{style:{fontSize:"1.25rem",fontWeight:650,lineHeight:1.2,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:f}),K&&e.jsxs("div",{style:{fontSize:"0.8rem",opacity:.75,marginTop:"0.2rem"},children:[e.jsx("span",{style:{opacity:.65},children:"Lineage:Â "}),K]}),q&&e.jsxs("div",{style:{fontSize:"0.72rem",opacity:.65,marginTop:"0.2rem"},children:["Scanned on ",Nr(q)]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.35rem",alignItems:"flex-end"},children:[A&&e.jsx("span",{style:{fontSize:"0.7rem",padding:"0.24rem 0.6rem",borderRadius:999,border:"1px solid rgba(178,255,89,0.8)",backgroundColor:"rgba(12,25,12,0.95)",textTransform:"uppercase",letterSpacing:"0.11em"},children:A}),e.jsxs("div",{style:{display:"flex",gap:"0.25rem",fontSize:"0.78rem",opacity:.88},children:[L&&e.jsx(rr,{label:"THC",value:L,highlight:"rgba(255,255,255,0.08)"}),b&&e.jsx(rr,{label:"CBD",value:b,highlight:"rgba(255,255,255,0.04)"})]})]})]}),e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.75rem"},children:[D.length>0&&e.jsx(nr,{title:"Typical effects",items:D,tone:"effects"}),N.length>0&&e.jsx(nr,{title:"Common flavors",items:N,tone:"flavors"})]})]})}function rr({label:n,value:r,highlight:f}){return e.jsxs("div",{style:{padding:"0.22rem 0.45rem",borderRadius:"0.55rem",backgroundColor:f,border:"1px solid rgba(190, 220, 190, 0.5)",minWidth:44,textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"0.62rem",textTransform:"uppercase",opacity:.7,letterSpacing:"0.09em"},children:n}),e.jsx("div",{style:{fontSize:"0.8rem",fontWeight:600},children:r})]})}function nr({title:n,items:r,tone:f}){const L=(Array.isArray(r)?r:[]).map(y=>{if(typeof y=="string")return y;if(y&&typeof y=="object"){if("name"in y)return String(y.name);if("label"in y)return String(y.label);if("value"in y)return String(y.value)}return null}).filter(Boolean);if(L.length===0)return null;const b=f==="flavors"?{chipBg:"rgba(255, 248, 225, 0.06)",chipBorder:"1px solid rgba(255, 236, 179, 0.7)",chipText:"#fff8e1",titleColor:"#fff9c4"}:{chipBg:"rgba(178, 255, 89, 0.08)",chipBorder:"1px solid rgba(200, 255, 140, 0.85)",chipText:"#e8ffca",titleColor:"#e8f5e9"};return e.jsxs("div",{style:{minWidth:0},children:[e.jsx("div",{style:{fontSize:"0.78rem",textTransform:"uppercase",letterSpacing:"0.08em",opacity:.8,marginBottom:"0.25rem",color:b.titleColor},children:n}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.3rem"},children:L.map((y,w)=>e.jsx("div",{style:{fontSize:"0.76rem",padding:"0.2rem 0.55rem",borderRadius:999,backgroundColor:b.chipBg,border:b.chipBorder,color:b.chipText,maxWidth:"100%"},children:y},`${n}-${w}`))})]})}function ar(n){return n?Array.isArray(n)?n.filter(Boolean):typeof n=="string"?n.split(",").map(r=>r.trim()).filter(Boolean):[]:[]}function tr(n){if(n==null)return null;const r=Number(n);return Number.isFinite(r)?r===0?"0%":r>0&&r<=1?`${(r*100).toFixed(1)}%`:r>1&&r<100?`${r.toFixed(1)}%`:`${r}%`:null}function _r(n){if(!n||typeof n!="string")return null;const r=n.toLowerCase();return r.includes("indica")&&r.includes("sativa")?"Hybrid":r.includes("indica")?"Indica":r.includes("sativa")?"Sativa":r.includes("hybrid")?"Hybrid":n.charAt(0).toUpperCase()+n.slice(1)}function Nr(n){try{const r=new Date(n);return Number.isNaN(r.getTime())?"":r.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch{return""}}async function sr(n,r=1280,f=.7){return new Promise((A,L)=>{const b=new Image;b.onload=()=>{const y=Math.min(1,r/b.width),w=document.createElement("canvas");w.width=b.width*y,w.height=b.height*y,w.getContext("2d").drawImage(b,0,0,w.width,w.height),w.toBlob(C=>{if(!C)return L(new Error("Failed to create blob"));const D=new FileReader;D.onloadend=()=>{const N=D.result||"",K=N.includes(",")?N.split(",")[1]:N;URL.revokeObjectURL(b.src),A({base64:K,contentType:"image/jpeg"})},D.onerror=()=>{URL.revokeObjectURL(b.src),L(new Error("Failed to read blob"))},D.readAsDataURL(C)},"image/jpeg",f)},b.onerror=()=>{URL.revokeObjectURL(b.src),L(new Error("Failed to load image"))},b.src=URL.createObjectURL(n)})}const Hr=20;function $r(){if(typeof window>"u")return 0;const n=window.localStorage.getItem("ss_guest_scans_used"),r=n?parseInt(n,10):0;return Number.isFinite(r)&&r>0?r:0}function Vr(n){typeof window>"u"||window.localStorage.setItem("ss_guest_scans_used",String(n))}function ze(n){return n.startsWith("/")||(n=`/${n}`),`${ir}${n}`}function an({onBack:n,onNavigate:r,onScanComplete:f}){const{user:A}=Er(),{isMember:L,starterRemaining:b,memberRemaining:y,memberCap:w,extraCredits:ne,totalAvailableScans:C,starterCap:D,registerScanConsumed:N}=Ur(),{proRole:K,proEnabled:q}=Or(),{canScan:ae,isFounder:H,remainingScans:te}=Fr(),{summary:se}=Wr?.()??{},le=H||!!(se?.unlimited||se?.isUnlimited||se?.membershipTier==="founder_unlimited"||se?.tier==="admin"),ce=A?.email??null,de=!A;c.useEffect(()=>{console.log("[FounderDebug]",{email:ce,isFounder:H,canScan:ae,remainingScans:te})},[ce,H,ae,te]);const[B,ue]=c.useState(null),[F,G]=c.useState(null),[W,Y]=c.useState(!1),[U,z]=c.useState(!1),[Be,Fe]=c.useState(!1),[Ee,ve]=c.useState(!1),[Ue,pe]=c.useState(null),[me,R]=c.useState(null),[Gr,ie]=c.useState(!1),[Oe,or]=c.useState(()=>$r()),[lr,ge]=c.useState(!1),[E,ye]=c.useState([]),[X,We]=c.useState(!1),Q=3,Me=ae??(H||le||C>0),[s,v]=c.useState("camera-loading"),[he,g]=c.useState("Opening scannerâ€¦"),[J,j]=c.useState({phase:"idle",message:"",details:""}),[Yr,oe]=c.useState(null),[Jr,$]=c.useState(null),[je,we]=c.useState(null),Z=c.useRef(null),[cr,dr]=c.useState(!1),[ee,ke]=c.useState(null),[ur,Ce]=c.useState(!1),[gr,Ie]=c.useState("scanner"),[S,_e]=c.useState(null),[Kr,Ne]=c.useState(null),Te=c.useRef(new Set),re=c.useRef(!1);c.useEffect(()=>{v("camera-loading"),g("Opening scannerâ€¦");const t=setTimeout(()=>{dr(!0),v("ready"),g("Take or choose a photo of any weed product or packaging.")},200);return()=>clearTimeout(t)},[]),c.useEffect(()=>()=>{F&&URL.revokeObjectURL(F),ee&&URL.revokeObjectURL(ee),E.forEach(t=>{t.previewUrl&&URL.revokeObjectURL(t.previewUrl)})},[]),c.useEffect(()=>{if(s==="done"&&S){const t=setTimeout(()=>{F&&(URL.revokeObjectURL(F),G(null)),ee&&(URL.revokeObjectURL(ee),ke(null))},2e3);return()=>clearTimeout(t)}},[s,S]);const hr=()=>{n&&n()},pr=()=>{R(null),$(null),v("ready"),g("Take or choose a photo of the product or packaging."),j({phase:"idle",message:"Ready to scan.",details:""}),ue(null),G(null),ke(null),pe(null),Y(!1),z(!1),Ie("scanner"),_e(null),Ne(null),ie(!1),we(null),re.current=!1,Te.current.clear(),ye([]),We(!1)},mr=async()=>{if(E.length===0){R("Please capture at least one photo");return}await Ge(E[0].file)},fr=()=>{We(!X),ye([]),ue(null),G(null),g(X?"Take or choose a photo of the product or packaging.":"Step 1/3: Capture the product from the front / top")},He=()=>{pr()},$e=()=>{Ie("scanner")},xr=kr.useCallback(t=>{if(!t||!t.id){console.warn("[SCAN] handleScanCompleted called with invalid scan",t);return}if(f&&typeof f=="function"){f(t);return}console.log("[SCAN] Completed, going to result page",t.id),Ne(t.id),Ie("result")},[]),Ve=async t=>{if(!t){R("Choose a photo first.");return}if(de&&Oe>=Hr){ge(!0);return}R(null),pe(null),await Ge(t)},br=t=>{Fe(!1),ve(!1);const x=t.target.files?.[0];if(!x)return;R(null),pe(null);const l=URL.createObjectURL(x);if(G(l),ke(I=>(I&&URL.revokeObjectURL(I),l)),Ce(!0),X&&E.length<Q){const I={file:x,previewUrl:l},d=[...E,I];if(ye(d),d.length>=Q)g(`All ${Q} photos captured. Ready to scan.`),v("ready");else{const i=d.length+1;g(`Step ${i}/${Q}: ${["Capture the product from the front / top","Capture from a side angle","Capture a close-up of the bud/label"][i-1]}`),v("ready")}}else ue(x),Y(!1),z(!1),v("capturing"),g("Preparing imageâ€¦"),Ve(x);t.target.value=""},yr=()=>{const t=document.getElementById("scan-file-input");t&&(Fe(!0),t.click())},Sr=()=>{const t=document.getElementById("scan-file-input");t&&(ve(!0),t.click(),setTimeout(()=>{ve(!1)},800))},vr=async()=>{await Ve(B)};async function Ge(t){if(!H&&!Me){R(`You're out of scans. Members get ${w} scans included; you can also top up scan packs any time.`);return}try{R(null),$(null),we(null),v("capturing"),oe(5),g("Preparing imageâ€¦"),j({phase:"uploading",message:"Preparing your scan...",details:""}),v("uploading"),oe(15),g("Resizing image for faster uploadâ€¦"),j({phase:"uploading",message:"Securely uploading your photo to our serversâ€¦",details:"We compress and encrypt your image for fast, secure processing."}),console.time("[Scanner] image-compression");const{base64:x,contentType:l}=await sr(t,1280,.7);console.timeEnd("[Scanner] image-compression"),oe(40),g("Uploading imageâ€¦"),j({phase:"uploading",message:"Securely uploading your photo to our serversâ€¦",details:"We compress and encrypt your image for fast, secure processing."});const I={filename:t.name||"scan.jpg",contentType:l||"image/jpeg",base64:x};console.time("[Scanner] upload");const d=await fetch(ze("/api/uploads"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)});console.timeEnd("[Scanner] upload");const i=await Je(d);if(!d.ok){if(d.status===403&&i?.error==="Guest scan limit reached"){ge(!0),Y(!1),z(!1),v("error"),g("Guest scan limit reached.");return}let u=i?.error||i?.hint||`Upload failed (${d.status})`;throw d.status===413||u.includes("too large")?u="Image is too large. Try taking the photo a bit farther away or with lower resolution.":d.status===400?u="Image problem (too large or wrong type). Try another photo.":d.status>=500&&(u="Scan failed on the server. Try again in a moment."),v("error"),new Error(u)}const h=i.id;if(console.log("[SCAN-ID] Received from backend",{scanId:h,responseData:i,hasId:!!i.id,hasScanId:!!i.scanId,hasScan_id:!!i.scan_id}),!h)throw console.error("[SCAN-ID] ERROR: No scan ID in backend response",{responseData:i,responseKeys:Object.keys(i||{})}),v("idle"),j({phase:"error",message:"Server did not return scan ID.",details:"Please try again."}),new Error("Did not receive a scan id from the server.");if(Z.current=h,we(h),console.log("[SCAN-ID] Stored scan ID",{scanId:h,storedInRef:Z.current}),j({phase:"queued",message:"Scan received. Getting in line...",details:"Our AI is about to process your image."}),!Te.current.has(h)){Te.current.add(h);try{let u=[];if(X&&E.length>1)for(let P=1;P<E.length;P++){const p=E[P],{base64:k,contentType:Re}=await sr(p.file,1280,.7),M={filename:p.file.name||`frame-${P}.jpg`,contentType:Re||"image/jpeg",base64:k},fe=await fetch(ze("/api/uploads"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)}),Se=await Je(fe);fe.ok&&Se.image_url&&u.push(Se.image_url)}console.time("[Scanner] process-trigger");const a=await fetch(ze(`/api/scans/${h}/process`),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({frameImageUrls:u})});if(console.timeEnd("[Scanner] process-trigger"),!a.ok){let P={};try{P=await a.json()}catch(k){console.warn("[startScan] Failed to parse error response",k)}console.error("[startScan] Process endpoint returned non-OK",{status:a.status,scanId:h,error:P?.error||P?.error?.message||"Unknown error",errorCode:P?.error?.code||null}),Y(!1),z(!1),v("error");const p=P?.error?.message||P?.error||P?.message||`Server returned ${a.status}`;$({type:"server",message:"We couldn't start this scan.",details:p+". Please try again in a moment.",scanId:h||void 0}),j({phase:"error",message:"Scan start failed.",details:"Our AI couldn't begin processing your image."}),R("We couldn't start this scan. Please try again in a moment."),g("Scan start failed. Please try again.");return}}catch(u){console.error("[startScan] Error triggering scan processing",{error:u,scanId:h,message:u?.message||String(u)}),Y(!1),z(!1),v("error"),$({type:"server",message:"We couldn't start this scan.",details:u?.message||"Failed to start scan processing. Please try again.",scanId:h||void 0}),j({phase:"error",message:"Scan start failed.",details:"Our AI couldn't begin processing your image."}),R("We couldn't start this scan. Please try again in a moment."),g("Scan start failed. Please try again.");return}}Y(!1),z(!0),v("processing"),oe(60),g("Processing image with Vision APIâ€¦"),j({phase:"processing",message:"Extracting text and visual featuresâ€¦",details:"Running Google Vision AI to read labels and analyze your photo."}),ie(!1),re.current=!1;const T=setTimeout(()=>{re.current||(console.warn("[Scanner] Scan timed out",{scanId:je}),z(!1),v("error"),$({type:"timeout",message:"Our AI took longer than expected.",details:"This scan may still finish in the background. It's usually a temporary slowdown on the server or network.",scanId:je||void 0}),j({phase:"error",message:"Scan is taking longer than normal.",details:"You can try again now, or wait a bit and retry on a stronger connection."}),R("Our AI took longer than expected to finish this scan. Please try again in a moment."),g("Scan timed out. Please try again."))},12e4);try{console.time("[Scanner] total-scan-time"),await Ye(h,0,T),console.timeEnd("[Scanner] total-scan-time")}finally{clearTimeout(T)}}catch(x){console.error("[Scanner] startScan error",x),Y(!1),z(!1),ie(!0),re.current=!0,v("error");const l=String(x?.message||x||"");let I="We couldn't finish this scan. Please try again.",d="unknown";const i=/ReferenceError|TypeError|SyntaxError|hasCompletedScanRef|Can't find variable|is not defined/i.test(l);i?(console.error("[Scanner] Internal error detected, showing generic message:",l),I="We couldn't finish this scan. Please try again.",d="client"):l.includes("413")||l.includes("too large")||l.includes("PayloadTooLargeError")?(I="Image is too large. Try taking the photo a bit farther away or with lower resolution.",d="client"):l.includes("400")||l.includes("Bad Request")?(I="Image problem (too large or wrong type). Try another photo.",d="client"):l.includes("Network")||l.includes("fetch")||l.includes("Failed to fetch")||/NetworkError|network/i.test(l)?(I="Network issue while scanning. Please check your connection and try again.",d="network"):l.includes("500")||l.includes("Internal Server Error")?(I="Scan failed on the server. Try again in a moment.",d="server"):l.includes("403")||l.includes("Guest scan limit")?(I="You've reached the guest scan limit. Sign up or upgrade to continue scanning.",d="server"):(!l||l==="undefined"||l==="null")&&(I="Something went wrong. Please try again.",d="unknown"),$({type:d,message:d==="network"?"Network issue during scan.":d==="server"?"Server couldn't finish your scan.":d==="client"?"App had trouble reading the scan result.":"We couldn't finish this scan.",details:i?"Internal error (see console)":l,scanId:je||void 0}),j({phase:"error",message:d==="network"?"Network issue.":d==="server"?"Server error.":"Display error.",details:d==="network"?"Check your connection and try again.":d==="server"?"Our AI had trouble finishing this scan.":"We'll fix this in an update."}),R(I),g(I)}}async function Ye(t,x=0,l=null){const i=Z.current||t;if(!i||typeof i!="string")throw console.error("[POLL] ERROR: Invalid scanId",{scanId:i,type:typeof i,refScanId:Z.current,passedScanId:t}),new Error(`Invalid scan ID: ${i}`);try{const h=Math.min(70+x*2,95);oe(h),x===0?(j({phase:"processing",message:"Extracting text and visual featuresâ€¦",details:"Running Google Vision AI to read labels and analyze your photo."}),g("Processing image with Vision APIâ€¦")):x<5?(j({phase:"processing",message:"Extracting text from labelâ€¦",details:"Reading product information and batch numbers."}),g("Extracting text from labelâ€¦")):x<10?j({phase:"matching",message:"Searching our database of 35,000+ strainsâ€¦",details:"Comparing visual features and text against our comprehensive strain library."}):x<20?(j({phase:"analyzing",message:"Decoding label details and generating AI insightsâ€¦",details:"Our AI extracts THC, CBD, effects, flavors, and warnings from the label."}),g("Analyzing product detailsâ€¦")):(j({phase:"finalizing",message:"Compiling your complete strain breakdownâ€¦",details:"Combining all analyses into a comprehensive result card."}),g("Finalizing resultsâ€¦")),x===0&&(console.time("[Scanner] polling"),console.log("[POLL] Starting poll",{scanId:i,passedScanId:t,refScanId:Z.current,maxAttempts:120,timeoutMs:120*1e3})),console.log("[POLL] Polling scanId",{attempt:x,scanId:i,passedScanId:t,refScanId:Z.current});const T=`${ir}/api/scans/${i}`;console.log("[POLL] Fetching scan",{scanId:i,url:T});const u=await fetch(T,{credentials:"include"});if(!u.ok){const p=await u.text().catch(()=>"(no body)");throw console.error("[POLL] non-OK response",{scanId:i,status:u.status,statusText:u.statusText,url:T,body:p}),new Error(`pollScan non-OK: ${u.status}`)}const a=await u.json();if(console.log("[POLL] raw scan data",{scanId:i,scan:a}),a.status==="completed"||a.status==="failed"||!!a.result||!!a.ai_summary||!!a.packaging_insights||!!a.label_insights){console.log("[POLL] Scan complete",{scanId:i,status:a.status,hasResult:!!a.result,hasAISummary:!!a.ai_summary,hasPackagingInsights:!!a.packaging_insights,hasLabelInsights:!!a.label_insights}),l&&clearTimeout(l),z(!1),ie(!0),re.current=!0,oe(100),j({phase:"finalizing",message:"Compiling your complete strain breakdownâ€¦",details:"Combining all analyses into a comprehensive result card."}),setTimeout(()=>{v("done"),g("Scan complete!"),R(null),$(null),j({phase:"completed",message:"Scan complete.",details:""}),oe(null)},800);const p=Qe(a),k=a.result;pe(p||{topMatch:null,otherMatches:[],matches:[],matched_strain_slug:null,labelInsights:k?.labelInsights||null,aiSummary:k?.labelInsights?.aiSummary||null,isPackagedProduct:k?.labelInsights?.isPackagedProduct||!1,packagingInsights:k?.packagingInsights||null,visionRaw:k?.vision_raw||null});const Re=a.result||p,M=Br(a);let fe=null;if(M&&M.strainName&&M.strainName!=="Cannabis (strain unknown)"){const xe=a.packaging_insights||a.result?.packagingInsights||null,Ke=a.label_insights||a.result?.labelInsights||null,jr=xe?.lineage||Ke?.lineage||null,wr=xe?.basic?.type||Ke?.type||null;fe={name:M.strainName,lineage:jr||null,type:wr||null,thc:M.thc||null,cbd:M.cbd||null,effects:M.effectsTags||null,flavors:M.flavorTags||null}}const Se=a.visionText||k?.vision_raw?.textAnnotations?.[0]?.description||k?.vision_raw?.fullTextAnnotation?.text||k?.visionRaw?.textAnnotations?.[0]?.description||k?.visionRaw?.fullTextAnnotation?.text||null;if(_e({id:a.id,result:Re,created_at:a.created_at||new Date().toISOString(),ai_summary:a.ai_summary||null,summary:a.summary||null,matchedStrain:fe||null,visionText:Se||null,matched_strain_slug:a.matched_strain_slug||null,transformed:M||null}),a.status==="completed"&&a.id&&xr(a),!L&&(N(),de)){const xe=Oe+1;or(xe),Vr(xe)}return}if(a.status==="failed"||a?.error){console.error("[POLL] scan failed",{scanId:i,attempt:x,status:a.status,error:a?.error}),l&&clearTimeout(l),z(!1),ie(!0),re.current=!0,v("error"),Ce(!1);const p=a?.error||a?.errorMessage||"Scan failed on the server.";let k=p;p.includes("Vision")||p.includes("OCR")?k="Could not read text from the image. Try a clearer photo with better lighting.":p.includes("match")||p.includes("strain")?k="Could not find a matching strain. Try a photo that shows the product label clearly.":(p.includes("storage")||p.includes("bucket"))&&(k="Storage error. Please try again in a moment."),$({type:"server",message:"Server couldn't finish your scan.",details:p,scanId:t||i||void 0}),j({phase:"error",message:"Server error.",details:"Our AI had trouble finishing this scan."}),R(k),g(k);return}if(x>=120){l&&clearTimeout(l),z(!1),ie(!0),re.current=!0,v("error"),Ce(!1),$({type:"timeout",message:"Our AI took longer than expected.",details:"This scan may still finish in the background. It's usually a temporary slowdown on the server or network.",scanId:t||i||void 0}),j({phase:"error",message:"Scan is taking longer than normal.",details:"You can try again now, or wait a bit and retry on a stronger connection."});const p="Our AI took longer than expected to finish this scan. Please try again in a moment.";R(p),g(p);return}setTimeout(()=>{const p=Z.current||i||t;if(!p)throw console.error("[POLL] ERROR: No scan ID available for next poll attempt",{attempt:x,scanId:t,currentScanId:i,refScanId:Z.current}),new Error("Scan ID lost during polling");Ye(p,x+1,l)},1e3)}catch(h){l&&clearTimeout(l),console.error("[Scanner] pollScan error",{scanId:i,attempt:x,message:h?.message||String(h),name:h?.name||"Error",stack:h?.stack||null,error:h}),z(!1),ie(!0),re.current=!0,v("error");const T=String(h?.message||h||"");let u="We couldn't finish this scan. Please try again.",a="unknown";const P=/ReferenceError|TypeError|SyntaxError|hasCompletedScanRef|Can't find variable|is not defined/i.test(T);throw P?(console.error("[Scanner] Internal error detected, showing generic message:",T),u="We couldn't finish this scan. Please try again.",a="client"):T.includes("404")||T.includes("not found")?(u="Scan not found. Please try scanning again.",a="server"):T.includes("500")||T.includes("Server error")?(u="Server error while processing scan. Please try again in a moment.",a="server"):(T.includes("Network")||T.includes("fetch")||/NetworkError|network/i.test(T))&&(u="Network issue while scanning. Please check your connection and try again.",a="network"),$({type:a,message:a==="network"?"Network issue during scan.":a==="server"?"Server couldn't finish your scan.":"App had trouble reading the scan result.",details:P?"Internal error (see console)":T,scanId:t||i||void 0}),j({phase:"error",message:a==="network"?"Network issue.":a==="server"?"Server error.":"Display error.",details:a==="network"?"Check your connection and try again.":a==="server"?"Our AI had trouble finishing this scan.":"We'll fix this in an update."}),R(u),g(u),h}}async function Je(t){try{return await t.json()}catch{return null}}return gr==="result"&&S?e.jsxs(V,{direction:"column",sx:{height:"100vh",overflow:"hidden",backgroundColor:"#050705",paddingTop:"calc(env(safe-area-inset-top) + 20px)",paddingBottom:"env(safe-area-inset-bottom)"},children:[e.jsxs(o,{sx:{flexShrink:0,px:2,pb:1,maxWidth:"md",mx:"auto",width:"100%"},children:[e.jsxs(o,{sx:{mb:2,mt:0,pt:0,display:"flex",alignItems:"center"},children:[e.jsx(qe,{onClick:$e,sx:{mr:1,color:"#C5E1A5"},"aria-label":"Back to home",children:e.jsx(Xe,{})}),e.jsx(m,{variant:"subtitle2",sx:{color:"#A5D6A7",fontWeight:500},children:"Back to scanner"})]}),e.jsx(o,{sx:{mb:2},children:e.jsx(m,{variant:"h5",sx:{color:"#F1F8E9",fontWeight:700,mb:.5},children:"Scan result"})})]}),e.jsx(o,{sx:{flex:1,minHeight:0,overflowY:"auto",overflowX:"hidden",WebkitOverflowScrolling:"touch",position:"relative"},children:e.jsxs(o,{sx:{px:2,pb:2,maxWidth:"md",mx:"auto",width:"100%"},children:[S?.matchedStrain&&e.jsx(o,{sx:{mb:1},children:e.jsx(Mr,{matchedStrain:S.matchedStrain,scan:S})}),!S?.matchedStrain&&e.jsxs(o,{sx:{mb:1.5,p:1,borderRadius:1.5,border:"1px solid rgba(90, 130, 90, 0.7)",background:"rgba(5, 10, 5, 0.96)",color:"#d6f5d6",fontSize:"0.84rem"},children:[e.jsx(m,{variant:"overline",sx:{fontSize:"0.78rem",letterSpacing:"0.08em",opacity:.75,mb:.5,display:"block"},children:"Scan details"}),e.jsx(o,{component:"pre",sx:{margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word",fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',fontSize:"0.76rem",opacity:.88},children:JSON.stringify({id:S.id,matched_strain_slug:S.matched_strain_slug,created_at:S.created_at},null,2)})]}),e.jsx(zr,{scan:S,result:Qe(S),onCorrectionSaved:()=>{console.log("[ScanResultCard] correction saved")}}),S?.summary&&e.jsx(o,{sx:{mt:2},children:e.jsx(Le,{summary:S.summary})}),S?.ai_summary&&!S?.summary&&e.jsx(o,{sx:{mt:2},children:e.jsx(Le,{aiSummary:S.ai_summary,visionText:S.visionText||null})}),S?.aiSummary&&!S?.summary&&!S?.ai_summary&&e.jsx(o,{sx:{mt:2},children:e.jsx(Le,{summary:S.aiSummary})})]})}),e.jsx(o,{sx:{flexShrink:0,p:2,borderTop:"1px solid rgba(255, 255, 255, 0.1)",background:"rgba(0, 0, 0, 0.3)",backdropFilter:"blur(12px)",maxWidth:"md",mx:"auto",width:"100%"},children:e.jsxs(V,{direction:"row",spacing:1.5,children:[e.jsx(_,{variant:"outlined",fullWidth:!0,onClick:$e,sx:{textTransform:"none",borderColor:"rgba(197, 225, 165, 0.8)",color:"#C5E1A5",fontWeight:500,"&:hover":{borderColor:"#CDDC39",backgroundColor:"rgba(156, 204, 101, 0.08)"}},children:"Back to scanner"}),e.jsx(_,{variant:"contained",fullWidth:!0,onClick:He,sx:{textTransform:"none",backgroundColor:"#9CCC65",color:"#050705",fontWeight:600,"&:hover":{backgroundColor:"#CDDC39"}},children:"Scan again"})]})})]}):cr?e.jsxs(o,{sx:{height:"100dvh",display:"flex",flexDirection:"column",overflow:"hidden",bgcolor:"#0a0f0a",position:"relative"},children:[e.jsxs(o,{sx:{flexShrink:0,display:"flex",alignItems:"center",paddingX:2,paddingTop:1.5,paddingBottom:1.5,gap:1.5,position:"relative",zIndex:1},children:[e.jsx(qe,{edge:"start",onClick:hr,sx:{mr:1,color:"#C5E1A5"},children:e.jsx(Xe,{})}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(m,{variant:"subtitle2",sx:{color:"rgba(255,255,255,0.7)"},children:"StrainSpotter"}),e.jsx(m,{variant:"h6",fontWeight:"600",sx:{color:"#fff"},children:"Scan a package or bud"})]})]}),e.jsxs(o,{sx:{flex:1,minHeight:0,overflowY:"auto",WebkitOverflowScrolling:"touch",px:2,pb:2,position:"relative",zIndex:1,bgcolor:"transparent"},children:[J.phase!=="idle"&&e.jsx(o,{sx:{pt:1,pb:1},children:e.jsxs(o,{sx:{padding:"8px 12px",borderRadius:"999px",fontSize:12,display:"flex",alignItems:"center",gap:1,backgroundColor:J.phase==="error"?"rgba(220, 53, 69, 0.12)":J.phase==="completed"?"rgba(25, 135, 84, 0.14)":"rgba(15, 118, 110, 0.16)",color:"#e5fbea",border:J.phase==="error"?"1px solid rgba(220, 53, 69, 0.3)":"none"},children:[e.jsx("span",{style:{fontSize:14},children:J.phase==="error"?"âš ï¸":J.phase==="completed"?"âœ…":"ðŸ”"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(o,{sx:{fontWeight:500,fontSize:13},children:J.message||"Ready to scan."}),J.details&&e.jsx(o,{sx:{fontSize:11,opacity:.8,mt:.25},children:J.details})]})]})}),e.jsxs(Cr,{maxWidth:"sm",sx:{px:0,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(o,{sx:{mb:2},children:e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1},children:[e.jsxs(o,{sx:{flex:1},children:[e.jsx(m,{variant:"h5",sx:{color:"#F1F8E9",fontWeight:700,mb:.5},children:"Scan weed products"}),e.jsx(m,{variant:"body2",sx:{color:"rgba(224, 242, 241, 0.9)"},children:"Choose or take a photo of a cannabis product or bud. We'll analyze it and show you the closest strain matches."})]}),e.jsx(o,{sx:{textAlign:"right",ml:2,minWidth:160},children:L?e.jsxs(e.Fragment,{children:[e.jsx(m,{variant:"caption",sx:{color:"rgba(163, 230, 186, 0.9)",fontWeight:700,textTransform:"uppercase",letterSpacing:"0.08em"},children:"Member"}),e.jsxs(m,{variant:"body2",sx:{color:"rgba(255,255,255,0.9)",fontWeight:500},children:["Included scans: ",w-y,"/",w]}),e.jsxs(m,{variant:"caption",sx:{color:"rgba(190, 242, 100, 0.9)"},children:["Scans left: ",C,ne>0?" (with top-ups)":""]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(m,{variant:"caption",sx:{color:"rgba(248, 250, 252, 0.7)"},children:["Free starter scans used:"," ",e.jsx("strong",{children:D-b})," / ",D]}),e.jsxs(m,{variant:"body2",sx:{mt:.25,color:C===0?"#fecaca":C<=5?"#fde68a":"#bbf7d0",fontWeight:600},children:["Scans available: ",C]}),ne>0&&e.jsxs(m,{variant:"caption",sx:{color:"rgba(190, 242, 100, 0.9)"},children:["Includes ",ne," top-up scans"]})]})})]})}),A&&e.jsxs(m,{variant:"caption",sx:{color:"#9CCC65",mb:1.5},children:["Signed in as ",A.email,". Your scans will be saved to your account."]}),e.jsx(Pe,{elevation:6,sx:{p:2.5,borderRadius:3,background:"rgba(12, 20, 12, 0.95)",border:"1px solid rgba(124, 179, 66, 0.6)",boxShadow:"0 18px 40px rgba(0, 0, 0, 0.7)",mb:3},children:e.jsxs(V,{spacing:2,children:[e.jsxs(o,{sx:{borderRadius:2,border:"2px dashed rgba(200, 230, 201, 0.5)",minHeight:200,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",background:"radial-gradient(circle at top, rgba(76, 175, 80, 0.15), rgba(0, 0, 0, 0.95))",position:"relative",animation:ur?"scan-pulse 1.4s infinite":"none","@keyframes scan-pulse":{"0%":{boxShadow:"0 0 0 0 rgba(0, 255, 120, 0.5)"},"70%":{boxShadow:"0 0 0 12px rgba(0, 255, 120, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(0, 255, 120, 0)"}}},children:[F?e.jsx(o,{component:"img",src:F,alt:"Selected to scan",sx:{width:"100%",maxHeight:280,objectFit:"cover"}}):e.jsxs(V,{spacing:1,alignItems:"center",children:[e.jsx(Ir,{sx:{fontSize:40,color:"#A5D6A7"}}),e.jsxs(m,{variant:"body2",sx:{color:"rgba(224, 242, 241, 0.9)"},children:[s==="ready"&&"Align the label in this area when you take the photo.",s==="capturing"&&"Preparing imageâ€¦",s==="uploading"&&(he||"Uploading imageâ€¦"),s==="processing"&&(he||"Processing image with Vision APIâ€¦"),s==="done"&&"Scan complete! You can review the details below.",s!=="ready"&&s!=="capturing"&&s!=="uploading"&&s!=="processing"&&s!=="done"&&"Tap below to take a new photo or choose one from your library."]})]}),ee&&e.jsx(o,{sx:{position:"absolute",bottom:8,right:8,width:64,height:64,borderRadius:1,overflow:"hidden",border:"1px solid rgba(255, 255, 255, 0.4)"},children:e.jsx(o,{component:"img",src:ee,alt:"Last captured",sx:{width:"100%",height:"100%",objectFit:"cover"}})})]}),e.jsx("input",{id:"scan-file-input",type:"file",accept:"image/*",style:{display:"none"},onChange:br}),e.jsxs(V,{spacing:1.5,children:[e.jsx(_,{variant:"contained",fullWidth:!0,size:"large",startIcon:e.jsx(Tr,{}),onClick:yr,disabled:!H&&!ae&&(Be||s==="uploading"||s==="processing"||s==="capturing"),sx:{textTransform:"none",fontWeight:700,py:1.3,borderRadius:2,background:"linear-gradient(135deg, #7CB342 0%, #9CCC65 50%, #CDDC39 100%)",boxShadow:"0 8px 32px rgba(124, 179, 66, 0.5), 0 0 40px rgba(124, 179, 66, 0.3)","&:hover":{background:"linear-gradient(135deg, #8BC34A 0%, #AED581 50%, #CDDC39 100%)",boxShadow:"0 12px 40px rgba(124, 179, 66, 0.7), 0 0 60px rgba(124, 179, 66, 0.4)"}},children:s==="uploading"?"Uploadingâ€¦":s==="processing"?"Processingâ€¦":Be?"Opening cameraâ€¦":H||ae?"Scan a package or bud":"Upgrade to keep scanning"}),e.jsx(_,{variant:"outlined",fullWidth:!0,size:"large",onClick:B?vr:Sr,disabled:!B&&Ee||W||U||F&&(W||U),sx:{textTransform:"none",fontWeight:700,py:1.1,borderRadius:2,borderColor:B?"#9CCC65":"rgba(200, 230, 201, 0.4)",color:B?"#C5E1A5":"rgba(224, 242, 241, 0.6)","&:hover":{borderColor:B?"#CDDC39":"rgba(200, 230, 201, 0.4)",backgroundColor:B?"rgba(156, 204, 101, 0.12)":"transparent"}},children:W?"Uploading photoâ€¦":U?"Analyzingâ€¦":B?"Start scan":Ee?"Opening photosâ€¦":"Choose photo"}),e.jsx(_,{variant:"text",size:"small",onClick:fr,sx:{textTransform:"none",color:X?"#CDDC39":"rgba(224, 242, 241, 0.7)",fontSize:"0.75rem",py:.5},children:X?"âœ“ Multi-angle mode":"Multi-angle mode (3 photos)"}),X&&E.length>0&&e.jsxs(o,{sx:{mt:1,p:1.5,borderRadius:1,backgroundColor:"rgba(124, 179, 66, 0.15)",border:"1px solid rgba(124, 179, 66, 0.3)"},children:[e.jsxs(m,{variant:"body2",sx:{color:"rgba(224, 242, 241, 0.9)",mb:.5},children:[E.length,"/",Q," photos captured"]}),E.length>=Q?e.jsx(_,{variant:"contained",fullWidth:!0,size:"medium",onClick:mr,disabled:!H&&(W||U||!Me),sx:{textTransform:"none",background:"linear-gradient(135deg, #7CB342, #9CCC65)",mt:.5},children:"Start multi-angle scan"}):e.jsxs(m,{variant:"caption",sx:{color:"rgba(224, 242, 241, 0.7)"},children:["Capture ",Q-E.length," more photo",Q-E.length>1?"s":""]})]}),e.jsx(m,{variant:"caption",sx:{color:"rgba(224, 242, 241, 0.8)"},children:X?"Capture the same product from different angles for better accuracy.":"Clear, close-up photos of labels or flowers give the best results."})]}),(F||B)&&e.jsxs(o,{sx:{mt:2,mb:1,borderRadius:2,overflow:"hidden",border:"1px solid",borderColor:"rgba(124, 179, 66, 0.3)",bgcolor:"rgba(0, 0, 0, 0.3)"},children:[e.jsx(o,{component:"img",src:F||(B?URL.createObjectURL(B):null),alt:"Selected photo",sx:{width:"100%",height:220,objectFit:"cover",display:"block"}}),e.jsx(o,{sx:{p:1.5,borderTop:"1px solid rgba(124, 179, 66, 0.2)"},children:e.jsxs(V,{direction:"row",spacing:1,alignItems:"center",children:[(W||U)&&e.jsx(Ae,{size:16,sx:{color:"#9CCC65"}}),e.jsx(m,{variant:"caption",sx:{color:W||U?"rgba(156, 204, 101, 0.9)":"rgba(224, 242, 241, 0.7)",fontSize:12,fontWeight:W||U?600:400},children:W?"Uploading photoâ€¦":U?"Processing scanâ€¦ this may take a few seconds.":"Photo selected. Ready to scan."})]})})]}),e.jsxs(o,{sx:{mt:2,p:1.5,borderRadius:1,backgroundColor:s==="error"?"rgba(239, 68, 68, 0.15)":"rgba(124, 179, 66, 0.1)",border:`1px solid ${s==="error"?"rgba(239, 68, 68, 0.4)":"rgba(124, 179, 66, 0.3)"}`},children:[e.jsxs(V,{direction:"row",spacing:1.5,alignItems:"center",children:[s!=="ready"&&s!=="done"&&s!=="error"&&e.jsx(Ae,{size:18,sx:{color:"#CDDC39"}}),s==="error"&&e.jsx(m,{sx:{color:"#fecaca",fontSize:18},children:"âš "}),e.jsxs(m,{variant:"body2",sx:{color:s==="error"?"#fecaca":"rgba(224, 242, 241, 0.9)",flex:1},children:[s==="ready"&&(he||"Ready to scan."),s==="capturing"&&"Preparing imageâ€¦",s==="uploading"&&(he||"Uploading imageâ€¦"),s==="processing"&&(he||"Processing image with Vision APIâ€¦"),s==="done"&&"Scan complete!",s==="error"&&(me||"Scan failed. Please try again.")]})]}),s==="error"&&e.jsx(_,{variant:"contained",fullWidth:!0,size:"medium",onClick:()=>{R(null),v("ready"),g("Ready to scan."),ue(null),G(null),F&&URL.revokeObjectURL(F),ee&&URL.revokeObjectURL(ee),ye([])},sx:{mt:1.5,textTransform:"none",background:"linear-gradient(135deg, #7CB342, #9CCC65)","&:hover":{background:"linear-gradient(135deg, #8BC34A, #AED581)"}},children:"Try again"})]}),me&&e.jsx(Rr,{severity:"warning",sx:{mt:1.5,backgroundColor:"rgba(255, 244, 179, 0.08)",color:"#FFF59D","& .MuiAlert-icon":{color:"#FFEE58"}},children:me})]})}),s!=="ready"&&s!=="done"&&s!=="error"&&!Ue&&!me&&e.jsx(Pe,{elevation:6,sx:{p:2.5,borderRadius:3,background:"rgba(12, 20, 12, 0.95)",border:"1px solid rgba(124, 179, 66, 0.6)",boxShadow:"0 18px 40px rgba(0, 0, 0, 0.7)",mb:3},children:e.jsxs(V,{spacing:2,children:[e.jsx(De,{variant:"text",width:"60%",height:40,sx:{bgcolor:"rgba(255, 255, 255, 0.1)"}}),e.jsx(De,{variant:"text",width:"100%",height:24,sx:{bgcolor:"rgba(255, 255, 255, 0.08)"}}),e.jsx(De,{variant:"text",width:"80%",height:24,sx:{bgcolor:"rgba(255, 255, 255, 0.08)"}})]})}),s==="error"&&e.jsx(_,{variant:"outlined",fullWidth:!0,onClick:He,sx:{mt:2,textTransform:"none",borderColor:"#9CCC65",color:"#C5E1A5","&:hover":{borderColor:"#CDDC39",backgroundColor:"rgba(156, 204, 101, 0.1)"}},children:"Scan again"}),!Ue&&s==="ready"&&!me&&e.jsx(m,{variant:"body2",sx:{color:"rgba(224, 242, 241, 0.8)",textAlign:"center"},children:"After you scan, we'll show you the best match and similar strains here."})]})]}),e.jsx(o,{sx:{height:8,flexShrink:0}}),e.jsxs(Pr,{open:lr,onClose:()=>ge(!1),fullWidth:!0,maxWidth:"xs",children:[e.jsx(Ar,{children:"Get more scans"}),e.jsxs(Dr,{dividers:!0,children:[e.jsx(m,{variant:"body2",sx:{mb:2},children:"You've used your 20 free guest scans. Join the garden to unlock full access and auto-refreshing monthly scan bundles."}),e.jsxs(V,{spacing:2,children:[e.jsx(_,{variant:"contained",fullWidth:!0,onClick:()=>{ge(!1),r?.("membership")},children:"View membership plans"}),e.jsx(_,{variant:"outlined",fullWidth:!0,onClick:()=>{ge(!1),r?.("buy-scans")},children:"Buy additional scan packs"})]})]}),e.jsx(Lr,{children:e.jsx(_,{onClick:()=>ge(!1),children:"Close"})})]})]}):e.jsx(o,{sx:{minHeight:"100vh",width:"100%",backgroundColor:"#050705",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:1,paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"},children:e.jsx(Pe,{elevation:6,sx:{p:4,borderRadius:3,background:"rgba(12, 20, 12, 0.95)",border:"1px solid rgba(124, 179, 66, 0.6)",textAlign:"center",maxWidth:320,pointerEvents:"auto"},children:e.jsxs(V,{spacing:2,alignItems:"center",children:[e.jsx(Ae,{size:48,sx:{color:"#CDDC39"}}),e.jsx(m,{variant:"h6",sx:{color:"#F1F8E9",fontWeight:600},children:he||"Opening cameraâ€¦"}),e.jsx(m,{variant:"body2",sx:{color:"rgba(224, 242, 241, 0.8)"},children:"Preparing scanner for you."})]})})})}export{an as default};
