import{r as n,j as e,D as R,p as q,B as c,_ as O,T as s,I as H,ai as N,q as V,n as Y,A as y,am as J,f,h as j,bq as k,i as u,H as v,br as K,u as Q}from"./react-vendor-CxfKVgr3.js";import{l as C,s as m,a as X}from"./App-JmJcCWdD.js";import"./vendor-DCH4KwNm.js";function se({open:h,onClose:x,currentTier:_="free",creditsRemaining:I=0}){const[d,F]=n.useState([]),[$,E]=n.useState(null),[T,P]=n.useState(!0),[g,i]=n.useState(!1),[S,o]=n.useState(null),[B,U]=n.useState(null);n.useEffect(()=>{h&&(C("credits_modal_opened"),G())},[h]);const G=async()=>{P(!0),o(null);try{let r=null;if(m){const{data:{session:W}}=await m.auth.getSession();r=W?.access_token||null}const a=r?{Authorization:`Bearer ${r}`}:{},A=await fetch(`${X}/api/credits/packages`,{headers:a}),l=await A.json();if(!A.ok||!l.success)throw new Error(l.error||"Unable to load packages");F(Array.isArray(l.packages)?l.packages:[]),E(l.role||null)}catch(r){console.error("Failed to fetch packages:",r),o(r.message||"Failed to load packages")}finally{P(!1)}},z=async r=>{C("credits_cta_clicked",{type:"top_up",packageId:r}),i(!0),o(null),U(null);try{const{data:{session:a}}=await m.auth.getSession();if(!a){o("Please sign in to purchase credits"),i(!1);return}o("Top-up purchases are coming soon! Contact support and mention the package you want.")}catch(a){console.error("Purchase error:",a),o("Purchase failed. Please try again.")}finally{i(!1)}},w=async r=>{C("credits_cta_clicked",{type:"membership",tierId:r}),i(!0),o(null),U(null);try{const{data:{session:a}}=await m.auth.getSession();if(!a){o("Please sign in to upgrade"),i(!1);return}o("Membership billing inside the app is coming soon. Contact support to upgrade manually.")}catch(a){console.error("Upgrade error:",a),o("Upgrade failed. Please try again.")}finally{i(!1)}},M=n.useMemo(()=>({premium:"monthly_member",member:"monthly_member",moderator:"monthly_member"}),[]),p=n.useMemo(()=>{const r=(_||"").toLowerCase();return M[r]||r||"free"},[_,M]),t=n.useMemo(()=>({appUnlock:d.find(r=>r.type==="app_purchase"),membership:d.find(r=>r.type==="membership"),topUps:d.filter(r=>r.type==="top_up")}),[d]),D=r=>r?`$${r.effectivePrice.toFixed(2)}`:"",L=r=>{if(!r?.credits)return"";const a=r.effectivePrice/r.credits;return a<1?`${(a*100).toFixed(1)}Â¢ per scan`:`$${a.toFixed(2)} per scan`},b=(r,{showRecurringLabel:a=!1}={})=>e.jsxs(c,{children:[e.jsxs(s,{variant:"h4",color:"primary",gutterBottom:!0,children:[D(r),a&&e.jsx(s,{component:"span",variant:"body2",color:"text.secondary",children:"/month"})]}),r?.moderatorDiscount&&e.jsxs(s,{variant:"body2",color:"text.secondary",sx:{textDecoration:"line-through"},children:["$",r.price.toFixed(2)]})]});return e.jsxs(R,{open:h,onClose:x,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{background:"linear-gradient(135deg, rgba(18, 18, 18, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(124, 179, 66, 0.2)"}},children:[e.jsxs(q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid rgba(124, 179, 66, 0.2)"},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(O,{sx:{color:"#7CB342"}}),e.jsx(s,{variant:"h6",children:"Get More Scans"})]}),e.jsx(H,{onClick:x,size:"small",children:e.jsx(N,{})})]}),e.jsx(V,{sx:{mt:2},children:T?e.jsx(c,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(Y,{})}):e.jsxs(e.Fragment,{children:[S&&e.jsx(y,{severity:"error",sx:{mb:2},onClose:()=>o(null),children:S}),B&&e.jsx(y,{severity:"success",sx:{mb:2},children:B}),e.jsxs(c,{sx:{mb:3,p:2,background:"rgba(124, 179, 66, 0.1)",borderRadius:2},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Current Plan: ",e.jsx("strong",{children:p.replace("_"," ").toUpperCase()})]}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Scans Remaining: ",e.jsx("strong",{children:I})]})]}),(t.appUnlock||t.membership)&&e.jsxs(e.Fragment,{children:[e.jsxs(s,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(J,{sx:{color:"#FFD700"}}),"Membership & Unlocks"]}),$==="moderator"&&e.jsx(y,{severity:"info",sx:{mb:2},children:"Moderator pricing applied automatically."}),e.jsxs(c,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"},gap:2,mb:4},children:[t.appUnlock&&p==="free"&&e.jsxs(f,{sx:{background:"linear-gradient(135deg, rgba(124, 179, 66, 0.12) 0%, rgba(156, 204, 101, 0.08) 100%)",border:"1px solid rgba(124, 179, 66, 0.25)"},children:[e.jsxs(j,{children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Unlock StrainSpotter"}),b(t.appUnlock),e.jsxs(s,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:[t.appUnlock.scans," starter scans (one-time)"]}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Own the app forever and unlock Groups, Grower tools, and the Garden."})]}),e.jsx(k,{children:e.jsxs(u,{fullWidth:!0,variant:"contained",color:"primary",disabled:g,onClick:()=>w("app_purchase"),children:["Unlock for ",D(t.appUnlock)]})})]},"app_purchase"),t.membership&&e.jsxs(f,{sx:{background:"linear-gradient(135deg, rgba(124, 179, 66, 0.15) 0%, rgba(156, 204, 101, 0.12) 100%)",border:"1px solid rgba(124, 179, 66, 0.35)",position:"relative"},children:[e.jsx(v,{label:"BEST VALUE",size:"small",color:"success",sx:{position:"absolute",top:-10,right:12,fontWeight:700}}),e.jsxs(j,{children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Monthly Member"}),b(t.membership,{showRecurringLabel:!0}),e.jsxs(s,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:[t.membership.scansPerMonth||200," scans/month + community perks"]}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Includes Groups, Grow Coach, Grower Directory, error reporting, and more."}),t.membership.moderatorDiscount&&e.jsx(v,{label:`${t.membership.moderatorDiscount.percent}% moderator discount`,size:"small",color:"success",sx:{mt:1}})]}),e.jsx(k,{children:e.jsx(u,{fullWidth:!0,variant:"contained",color:"primary",disabled:g||p==="monthly_member",onClick:()=>w("monthly_member"),children:p==="monthly_member"?"Membership Active":"Upgrade to Monthly Member"})})]},"monthly_member")]})]}),e.jsxs(s,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{sx:{color:"#7CB342"}}),"Buy Credit Packs"]}),e.jsx(c,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"},gap:2},children:t.topUps.map(r=>e.jsxs(f,{sx:{background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(124, 179, 66, 0.2)",transition:"all 0.2s ease","&:hover":{transform:"translateY(-2px)",border:"1px solid rgba(124, 179, 66, 0.5)"}},children:[e.jsxs(j,{children:[e.jsxs(s,{variant:"h6",gutterBottom:!0,children:[r.credits," Scans"]}),b(r),e.jsx(s,{variant:"body2",color:"text.secondary",children:L(r)}),r.moderatorDiscount&&e.jsx(v,{label:`${r.moderatorDiscount.percent}% moderator discount`,size:"small",color:"success",sx:{mt:1}})]}),e.jsx(k,{children:e.jsx(u,{fullWidth:!0,variant:"outlined",color:"primary",disabled:g,onClick:()=>z(r.id),children:"Buy Now"})})]},r.id))})]})}),e.jsx(Q,{sx:{borderTop:"1px solid rgba(124, 179, 66, 0.2)",p:2},children:e.jsx(u,{onClick:x,color:"inherit",children:"Close"})})]})}export{se as default};
