import{r as t,j as e,C,av as Z,i as m,A as v,T as a,S as E,f as g,h as b,k as ee,l as se,bi as ae,P as te,bd as oe,be as re,bf as F,bg as o,bh as ne,H as ie,Q as T,I as A,bj as le,$ as ce,K as de,D as he,p as xe,q as ue,B as je,m as pe,u as me}from"./react-vendor-CxfKVgr3.js";import{s as ve,a as f}from"./App-JmJcCWdD.js";import"./vendor-DCH4KwNm.js";const k=[{value:"pending",label:"New"},{value:"in_progress",label:"In Progress"},{value:"resolved",label:"Resolved"}];function ye({onBack:h}){const[D,N]=t.useState({pending:[],in_progress:[],resolved:[]}),[x,q]=t.useState(null),[H,W]=t.useState(!0),[c,M]=t.useState(null),[L,u]=t.useState(!1),[_,$]=t.useState(""),[n,O]=t.useState("approve"),[y,i]=t.useState(null),[B,U]=t.useState("pending"),[j,G]=t.useState(null),[w,J]=t.useState(!1),[K,R]=t.useState(!1);t.useEffect(()=>{Q()},[]),t.useEffect(()=>{w&&j&&z()},[w,j]);const Q=async()=>{try{const{data:{session:s}}=await ve.auth.getSession();if(!s?.access_token){i("Sign in required to access moderation tools."),R(!0);return}const r=await fetch(`${f}/api/users/onboarding-status`,{headers:{Authorization:`Bearer ${s.access_token}`}});if(!r.ok){i("Failed to verify permissions."),R(!0);return}const d=(await r.json())?.profile?.role;d==="admin"||d==="moderator"?(J(!0),G(s.access_token)):i("Moderator access required.")}catch(s){console.error("[Moderation] Access check failed:",s),i("Unable to verify access.")}finally{R(!0)}},z=async()=>{try{W(!0);const s={Authorization:`Bearer ${j}`},r=await Promise.all(k.map(l=>fetch(`${f}/api/moderation/reports?status=${l.value}`,{headers:s}))),p={};await Promise.all(r.map(async(l,X)=>{const I=k[X];if(l.ok){const Y=await l.json();p[I.value]=Y.reports||[]}else p[I.value]=[]})),N(l=>({...l,...p}));const d=await fetch(`${f}/api/moderation/stats`,{headers:s});if(d.ok){const l=await d.json();q(l)}}catch(s){console.error("[Moderation] Load error:",s),i("Failed to load moderation data")}finally{W(!1)}},V=async()=>{if(c)try{i(null);const s=await fetch(`${f}/api/moderation/reports/${c.id}/resolve`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`},body:JSON.stringify({action:n,moderator_notes:_})});if(!s.ok){const r=await s.json();throw new Error(r.error||"Failed to resolve report")}u(!1),M(null),$(""),z()}catch(s){i(s.message)}},S=(s,r)=>{M(s),O(r),u(!0)};if(!K||H)return e.jsx(C,{maxWidth:"lg",sx:{py:4},children:e.jsx(Z,{})});if(!w)return e.jsxs(C,{maxWidth:"sm",sx:{py:6},children:[h&&e.jsx(m,{onClick:h,size:"small",variant:"contained",sx:{mb:2},children:"Home"}),e.jsx(v,{severity:"warning",children:y||"Moderator access required to view this dashboard."})]});const P=D[B]||[];return e.jsxs(C,{maxWidth:"lg",sx:{py:4},children:[h&&e.jsx(m,{onClick:h,size:"small",variant:"contained",sx:{bgcolor:"white",color:"black",textTransform:"none",fontWeight:700,borderRadius:999,mb:1,"&:hover":{bgcolor:"grey.100"}},children:"Home"}),e.jsx(a,{variant:"h4",sx:{fontWeight:800,mb:3},children:"Moderation Dashboard"}),y&&e.jsx(v,{severity:"error",sx:{mb:3},onClose:()=>i(null),children:y}),x&&e.jsxs(E,{direction:"row",spacing:2,sx:{mb:4},children:[e.jsx(g,{sx:{flex:1},children:e.jsxs(b,{children:[e.jsx(a,{variant:"h3",color:"warning.main",sx:{fontWeight:700},children:x.pendingReports}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Pending Reports"})]})}),e.jsx(g,{sx:{flex:1},children:e.jsxs(b,{children:[e.jsx(a,{variant:"h3",color:"success.main",sx:{fontWeight:700},children:x.resolvedReports}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Resolved Reports"})]})}),e.jsx(g,{sx:{flex:1},children:e.jsxs(b,{children:[e.jsx(a,{variant:"h3",color:"primary.main",sx:{fontWeight:700},children:x.totalMessages}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Total Messages"})]})})]}),e.jsx(g,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"h6",sx:{mb:2,fontWeight:700},children:"Report Triage"}),e.jsx(ee,{value:B,onChange:(s,r)=>U(r),sx:{mb:2},variant:"scrollable",allowScrollButtonsMobile:!0,children:k.map(s=>e.jsx(se,{value:s.value,label:`${s.label} (${D[s.value]?.length||0})`},s.value))}),P.length===0?e.jsx(v,{severity:"info",children:"No reports in this queue. Great job!"}):e.jsx(ae,{component:te,variant:"outlined",children:e.jsxs(oe,{children:[e.jsx(re,{children:e.jsxs(F,{children:[e.jsx(o,{children:"Report ID"}),e.jsx(o,{children:"Reason"}),e.jsx(o,{children:"Message Content"}),e.jsx(o,{children:"Reporter"}),e.jsx(o,{children:"Reported"}),e.jsx(o,{align:"right",children:"Actions"})]})}),e.jsx(ne,{children:P.map(s=>e.jsxs(F,{hover:!0,children:[e.jsx(o,{children:e.jsxs(a,{variant:"caption",sx:{fontFamily:"monospace"},children:[s.id.slice(0,8),"..."]})}),e.jsx(o,{children:e.jsx(ie,{label:s.reason,size:"small",color:s.reason==="harassment"?"error":"warning"})}),e.jsxs(o,{children:[e.jsx(a,{variant:"body2",sx:{maxWidth:300},noWrap:!0,children:s.messages?.content||"(message deleted)"}),s.details&&e.jsxs(a,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:["Details: ",s.details]})]}),e.jsx(o,{children:s.reported_by?e.jsxs(a,{variant:"caption",sx:{fontFamily:"monospace"},children:[s.reported_by.slice(0,8),"..."]}):e.jsx(a,{variant:"caption",color:"text.secondary",children:"Anonymous"})}),e.jsx(o,{children:e.jsx(a,{variant:"caption",color:"text.secondary",children:new Date(s.created_at).toLocaleString()})}),e.jsx(o,{align:"right",children:e.jsxs(E,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(T,{title:"Approve (false positive)",children:e.jsx(A,{size:"small",color:"success",onClick:()=>S(s,"approve"),children:e.jsx(le,{})})}),e.jsx(T,{title:"Warn user",children:e.jsx(A,{size:"small",color:"warning",onClick:()=>S(s,"warn"),children:e.jsx(ce,{})})}),e.jsx(T,{title:"Remove message",children:e.jsx(A,{size:"small",color:"error",onClick:()=>S(s,"remove"),children:e.jsx(de,{})})})]})})]},s.id))})]})})]})}),e.jsxs(he,{open:L,onClose:()=>u(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(xe,{children:["Resolve Report: ",n==="approve"?"Approve":n==="warn"?"Warn User":"Remove Message"]}),e.jsxs(ue,{children:[c&&e.jsxs(je,{sx:{mb:2},children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Message Content:"}),e.jsx(a,{variant:"body1",sx:{mb:2,p:1,bgcolor:"grey.100",borderRadius:1},children:c.messages?.content||"(message deleted)"}),e.jsxs(a,{variant:"subtitle2",color:"text.secondary",children:["Reason: ",c.reason]}),c.details&&e.jsxs(a,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Details: ",c.details]})]}),e.jsx(pe,{label:"Moderator Notes (optional)",multiline:!0,rows:3,fullWidth:!0,value:_,onChange:s=>$(s.target.value),placeholder:"Add any notes about this decision..."}),n==="remove"&&e.jsx(v,{severity:"warning",sx:{mt:2},children:"This will permanently delete the message from the database."})]}),e.jsxs(me,{children:[e.jsx(m,{onClick:()=>u(!1),children:"Cancel"}),e.jsx(m,{onClick:V,variant:"contained",color:n==="remove"?"error":n==="warn"?"warning":"success",children:n==="approve"?"Approve":n==="warn"?"Warn User":"Remove Message"})]})]})]})}export{ye as default};
