import{r as t,j as e,D as L,p as z,q as Y,B as l,A as v,bl as $,bm as G,bn as H,T as c,m as J,aF as K,aG as Q,s as U,t as V,S as X,i as x}from"./react-vendor-CxfKVgr3.js";import{u as W,a as _,s as E}from"./App-JmJcCWdD.js";import"./vendor-DCH4KwNm.js";function Z(){const{session:d,user:h}=W(),[g,r]=t.useState({loading:!0,error:null,onboardingRequired:!1,needsDisplayName:!1,needsRole:!1,needsPersona:!1,profile:null}),p=t.useCallback(async()=>{if(!h||!d?.access_token){r(o=>({...o,loading:!1,onboardingRequired:!1,profile:null,error:null}));return}r(o=>({...o,loading:!0,error:null}));try{const o=await fetch(`${_}/api/users/onboarding-status`,{headers:{Authorization:`Bearer ${d.access_token}`}});if(!o.ok){const f=await o.json().catch(()=>({}));throw new Error(f.error||"Failed to load onboarding status")}const n=await o.json();r({loading:!1,error:null,onboardingRequired:!!n.onboardingRequired,needsDisplayName:!!n.needsDisplayName,needsRole:!!n.needsRole,needsPersona:!!n.needsPersona,profile:n.profile})}catch(o){console.error("[useOnboardingStatus] Failed to load status:",o),r(n=>({...n,loading:!1,error:o.message||"Failed to load onboarding status"}))}},[h,d?.access_token]);return t.useEffect(()=>{p()},[p]),{...g,refresh:p}}const ee=[{value:"enthusiast",label:"Enthusiast",description:"I explore strains, dispensaries, and community content."},{value:"grower",label:"Grower",description:"I cultivate, test, and share knowledge with others."},{value:"operator",label:"Business",description:"I run a dispensary, delivery service, or cannabis brand."}];function re(){const{user:d}=W(),{onboardingRequired:h,loading:g,profile:r,refresh:p,needsDisplayName:o,needsPersona:n,needsRole:f,error:w}=Z(),[a,m]=t.useState(0),[y,C]=t.useState(""),[u,k]=t.useState(""),[B,P]=t.useState(!1),[S,D]=t.useState(!1),[R,T]=t.useState(null),[N,j]=t.useState(!1);t.useEffect(()=>{if(r){C(r.display_name||"");const s=r.profile_tags?.find(i=>i.startsWith("persona:"));k(s?s.replace("persona:",""):""),P(r.profile_tags?.some(i=>i.startsWith("notify:"))||!1)}},[r]);const b=t.useMemo(()=>[{label:"Profile",description:"Set your public name so others recognize you."},{label:"Role",description:"Tell us how you use StrainSpotter."},{label:"Preferences",description:"Stay in the loop with community updates."}],[]),O=!!(d&&h),F=y.trim().length>=2,A=!!u,I=async()=>{if(!(!E||!d)){D(!0),T(null),j(!1);try{const{data:{session:s}}=await E.auth.getSession();if(!s?.access_token)throw new Error("Session expired. Please sign in again.");const i=await fetch(`${_}/api/users/onboarding`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`},body:JSON.stringify({display_name:y.trim(),role:u==="grower"?"grower":u==="operator"?"operator":"member",persona:u,notifications:B})});if(!i.ok){const M=await i.json().catch(()=>({}));throw new Error(M.error||"Failed to save onboarding data")}j(!0),await p(),setTimeout(()=>{j(!1)},3e3)}catch(s){console.error("[OnboardingFlow] Submit failed:",s),T(s.message||"Failed to complete onboarding")}finally{D(!1)}}},q=o||n||f;return O?e.jsxs(L,{open:!0,fullScreen:!0,PaperProps:{sx:{background:"#041204",color:"#fff"}},children:[e.jsx(z,{sx:{textAlign:"center",fontWeight:700,color:"#CDDC39",pt:4},children:"Welcome to StrainSpotter"}),e.jsxs(Y,{sx:{maxWidth:520,mx:"auto",width:"100%",height:"100%",display:"flex",flexDirection:"column",pt:1,pb:6},children:[e.jsxs(l,{sx:{overflowY:"auto",pr:1,flex:1,"&::-webkit-scrollbar":{width:6},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.2)",borderRadius:999}},children:[w&&e.jsx(v,{severity:"error",sx:{mb:2},children:w}),q&&e.jsxs(l,{sx:{mb:3},children:[e.jsx($,{activeStep:a,alternativeLabel:!0,children:b.map(s=>e.jsx(G,{children:e.jsx(H,{children:s.label})},s.label))}),e.jsx(c,{variant:"body2",sx:{mt:1,textAlign:"center",color:"#ccc"},children:b[a]?.description})]}),a===0&&e.jsxs(l,{sx:{mt:3},children:[e.jsx(c,{variant:"h6",sx:{mb:1,fontWeight:700},children:"How should the community address you?"}),e.jsx(J,{value:y,onChange:s=>C(s.target.value),label:"Display Name",fullWidth:!0,autoFocus:!0,inputProps:{maxLength:60},helperText:"Shown in chats, groups, and grower directory.",sx:{"& .MuiOutlinedInput-root":{color:"#fff"},"& .MuiInputLabel-root":{color:"#bbb"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"rgba(255,255,255,0.3)"}}})]}),a===1&&e.jsxs(l,{sx:{mt:2},children:[e.jsx(c,{variant:"h6",sx:{mb:1,fontWeight:700},children:"Choose your primary role"}),e.jsx(K,{exclusive:!0,fullWidth:!0,color:"success",value:u,onChange:(s,i)=>i&&k(i),orientation:"vertical",children:ee.map(s=>e.jsx(Q,{value:s.value,sx:{mb:1,textTransform:"none",justifyContent:"flex-start",borderRadius:2,bgcolor:u===s.value?"rgba(124,179,66,0.25)":"rgba(255,255,255,0.05)"},children:e.jsxs(l,{sx:{textAlign:"left"},children:[e.jsx(c,{variant:"subtitle1",sx:{fontWeight:700},children:s.label}),e.jsx(c,{variant:"caption",sx:{color:"#ccc"},children:s.description})]})},s.value))})]}),a===2&&e.jsxs(l,{sx:{mt:3},children:[e.jsx(c,{variant:"h6",sx:{mb:1,fontWeight:700},children:"Stay in the loop?"}),e.jsx(c,{variant:"body2",sx:{mb:2,color:"#ccc"},children:"Receive occasional emails about new groups, grower spotlights, and product updates. You can change this anytime in settings."}),e.jsx(U,{control:e.jsx(V,{checked:B,onChange:s=>P(s.target.checked),sx:{color:"#CDDC39"}}),label:"Yes, send me StrainSpotter updates"})]}),R&&e.jsx(v,{severity:"error",sx:{mt:3},children:R}),N&&e.jsx(v,{severity:"success",sx:{mt:3},children:"Profile updated! You’re all set."})]}),e.jsxs(X,{direction:"row",spacing:2,sx:{mt:4},children:[a>0&&e.jsx(x,{variant:"outlined",onClick:()=>m(s=>Math.max(s-1,0)),sx:{flex:1},children:"Back"}),a<b.length-1&&e.jsx(x,{variant:"contained",disabled:S||a===0&&!F||a===1&&!A,onClick:()=>m(s=>Math.min(s+1,b.length-1)),sx:{flex:1,bgcolor:"#7CB342",color:"#fff","&:hover":{bgcolor:"#8bc34a"}},children:"Continue"}),a===b.length-1&&e.jsx(x,{variant:"contained",disabled:S||!F||!A,onClick:I,sx:{flex:1,bgcolor:"#7CB342",color:"#fff","&:hover":{bgcolor:"#8bc34a"}},children:S?"Saving…":"Finish"})]}),!g&&!h&&e.jsx(l,{sx:{mt:3,textAlign:"center"},children:e.jsx(x,{onClick:()=>m(0),size:"small",sx:{color:"#ccc"},children:"Revisit onboarding"})})]})]}):null}export{re as default};
