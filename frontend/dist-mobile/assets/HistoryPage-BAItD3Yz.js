import{j as e,f as R,h as $,B as a,S as y,T as t,H as p,ac as H,a3 as L,Z as k,ad as q,$ as J,r as h,C as M,I as P,y as D,ae as T,af as B,ag as O,ah as C,m as K,n as Q,A as V}from"./react-vendor-CxfKVgr3.js";import{t as ee,S as re}from"./ScanResultCard-Cv4hIP62.js";import{u as se,c as ne,a as ae}from"./App-JmJcCWdD.js";import"./vendor-DCH4KwNm.js";import"./useStrainImage-pCt_md2M.js";function te({scan:s,onClick:_}){if(!s)return null;const c=ee(s),d=c?.strainName||s.canonical_strain_name||s.matched_strain_name||"Unknown",i=c?.isPackagedProduct||!1,x=c?.matchConfidence||s.canonical_match_confidence||s.match_confidence||null,S=c?.intensity||s.ai_summary?.intensity||s.ai_summary?.potency_score||null,l=s.pro_role,b=new Date(s.created_at),u=b.toLocaleDateString("en-US",{month:"short",day:"numeric",year:b.getFullYear()!==new Date().getFullYear()?"numeric":void 0}),j=b.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),g=s.image_url||null;return e.jsx(R,{onClick:_,sx:{mb:2,cursor:"pointer",background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(124, 179, 66, 0.2)",backdropFilter:"blur(6px)",transition:"all 0.2s","&:hover":{borderColor:"rgba(124, 179, 66, 0.4)",background:"rgba(255, 255, 255, 0.08)",transform:"translateY(-2px)"}},children:e.jsx($,{sx:{p:2,"&:last-child":{pb:2}},children:e.jsxs(a,{sx:{display:"flex",gap:2},children:[g&&e.jsx(a,{sx:{width:80,height:80,borderRadius:2,overflow:"hidden",flexShrink:0,background:"rgba(0, 0, 0, 0.3)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("img",{src:g,alt:"Scan",style:{width:"100%",height:"100%",objectFit:"cover"},onError:m=>{m.target.style.display="none"}})}),e.jsx(a,{sx:{flex:1,minWidth:0},children:e.jsxs(y,{spacing:1,children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(t,{variant:"h6",sx:{color:"#E8F5E9",fontWeight:700,fontSize:"1rem",flex:1,minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:d}),e.jsx(p,{icon:i?e.jsx(H,{}):e.jsx(L,{}),label:i?"Packaged":"Bud",size:"small",sx:{height:"24px",fontSize:"0.7rem",bgcolor:i?"rgba(124, 179, 66, 0.15)":"rgba(179, 229, 252, 0.15)",color:i?"#9AE66E":"#B3E5FC",border:`1px solid ${i?"rgba(124, 179, 66, 0.3)":"rgba(179, 229, 252, 0.3)"}`}}),l&&e.jsx(p,{label:l==="dispensary"?"Dispensary":"Grower",size:"small",sx:{height:"20px",fontSize:"0.65rem",bgcolor:"rgba(124, 179, 66, 0.2)",color:"#9AE66E",border:"1px solid rgba(124, 179, 66, 0.4)"}})]}),e.jsxs(t,{variant:"caption",sx:{color:"rgba(200, 230, 201, 0.7)"},children:[u," â€¢ ",j]}),e.jsxs(y,{direction:"row",spacing:1,flexWrap:"wrap",gap:.5,children:[!i&&x!==null&&e.jsx(p,{label:`${Math.round(x*100)}% match`,size:"small",sx:{height:"20px",fontSize:"0.65rem",bgcolor:x>=.8?"rgba(76, 175, 80, 0.2)":"rgba(255, 152, 0, 0.2)",color:x>=.8?"#81C784":"#FFB74D",border:`1px solid ${x>=.8?"rgba(76, 175, 80, 0.3)":"rgba(255, 152, 0, 0.3)"}`}}),S!==null&&e.jsx(p,{label:`Intensity: ${S.toFixed(1)}/5`,size:"small",sx:{height:"20px",fontSize:"0.65rem",bgcolor:"rgba(255, 204, 128, 0.15)",color:"#FFCC80",border:"1px solid rgba(255, 204, 128, 0.3)"}})]})]})})]})})})}function oe({scans:s,proRole:_}){if(!s||s.length===0)return null;const c=new Date,d=new Date(c.getFullYear(),c.getMonth(),1),i=s.filter(r=>new Date(r.created_at)>=d),x=s.filter(r=>{const n=r.packaging_insights||r.label_insights||{};return!!(n.strainName||n.basic?.strain_name)}),S=s.filter(r=>{const n=r.packaging_insights||r.label_insights||{};return!(n.strainName||n.basic?.strain_name)}),l={};s.forEach(r=>{const n=r.canonical_strain_name||r.matched_strain_name||"Unknown";l[n]=(l[n]||0)+1});const b=Object.entries(l).sort((r,n)=>n[1]-r[1]).slice(0,3).map(([r,n])=>({name:r,count:n})),u=s.map(r=>r.ai_summary?.intensity||r.ai_summary?.potency_score).filter(r=>typeof r=="number"),j=u.length>0?u.reduce((r,n)=>r+n,0)/u.length:null,g=s.filter(r=>{const n=r.ai_summary?.risksAndWarnings||r.ai_summary?.warnings||[];return Array.isArray(n)&&n.length>0}).length,m=s.filter(r=>r.pro_role==="dispensary").length,f=s.filter(r=>r.pro_role==="grower").length;return e.jsx(R,{sx:{mb:3,background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(124, 179, 66, 0.3)",backdropFilter:"blur(6px)"},children:e.jsxs($,{children:[e.jsx(t,{variant:"h6",sx:{mb:2,color:"#E8F5E9",fontWeight:700},children:"Analytics Summary"}),e.jsxs(y,{spacing:2,children:[e.jsxs(a,{children:[e.jsx(t,{variant:"body2",sx:{color:"rgba(200, 230, 201, 0.7)",mb:.5},children:"This Month"}),e.jsxs(t,{variant:"h5",sx:{color:"#E8F5E9",fontWeight:700},children:[i.length," scans"]})]}),e.jsx(k,{sx:{borderColor:"rgba(124, 179, 66, 0.2)"}}),e.jsxs(a,{children:[e.jsx(t,{variant:"body2",sx:{color:"rgba(200, 230, 201, 0.7)",mb:1},children:"Product Type"}),e.jsxs(y,{direction:"row",spacing:1,flexWrap:"wrap",gap:1,children:[e.jsx(p,{icon:e.jsx(H,{}),label:`${x.length} Packaged`,size:"small",sx:{bgcolor:"rgba(124, 179, 66, 0.15)",color:"#9AE66E",border:"1px solid rgba(124, 179, 66, 0.3)"}}),e.jsx(p,{icon:e.jsx(L,{}),label:`${S.length} Bud`,size:"small",sx:{bgcolor:"rgba(124, 179, 66, 0.15)",color:"#9AE66E",border:"1px solid rgba(124, 179, 66, 0.3)"}})]}),s.length>0&&e.jsxs(t,{variant:"caption",sx:{color:"rgba(200, 230, 201, 0.6)",mt:.5,display:"block"},children:[Math.round(x.length/s.length*100),"% packaged"]})]}),b.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderColor:"rgba(124, 179, 66, 0.2)"}}),e.jsxs(a,{children:[e.jsx(t,{variant:"body2",sx:{color:"rgba(200, 230, 201, 0.7)",mb:1},children:"Top Strains"}),e.jsx(y,{spacing:.5,children:b.map(({name:r,count:n},I)=>e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(t,{variant:"body2",sx:{color:"#E8F5E9"},children:[I+1,". ",r]}),e.jsx(p,{label:n,size:"small",sx:{bgcolor:"rgba(124, 179, 66, 0.15)",color:"#9AE66E",height:"20px",fontSize:"0.7rem"}})]},I))})]})]}),j!==null&&e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderColor:"rgba(124, 179, 66, 0.2)"}}),e.jsxs(a,{children:[e.jsx(t,{variant:"body2",sx:{color:"rgba(200, 230, 201, 0.7)",mb:.5},children:"Avg AI Intensity"}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(q,{sx:{color:"#9AE66E",fontSize:"1.2rem"}}),e.jsxs(t,{variant:"h6",sx:{color:"#E8F5E9",fontWeight:700},children:[j.toFixed(1),"/5"]})]})]})]}),g>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderColor:"rgba(124, 179, 66, 0.2)"}}),e.jsxs(a,{children:[e.jsx(t,{variant:"body2",sx:{color:"rgba(200, 230, 201, 0.7)",mb:.5},children:"Warnings Encountered"}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(J,{sx:{color:"#FFCC80",fontSize:"1.2rem"}}),e.jsxs(t,{variant:"h6",sx:{color:"#FFCC80",fontWeight:700},children:[g," scans"]})]})]})]}),(_||m>0||f>0)&&e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderColor:"rgba(124, 179, 66, 0.2)"}}),e.jsxs(a,{children:[e.jsx(t,{variant:"body2",sx:{color:"rgba(200, 230, 201, 0.7)",mb:1},children:"Pro Mode Breakdown"}),e.jsxs(y,{direction:"row",spacing:1,flexWrap:"wrap",gap:1,children:[m>0&&e.jsx(p,{label:`${m} Dispensary`,size:"small",sx:{bgcolor:"rgba(124, 179, 66, 0.15)",color:"#9AE66E",border:"1px solid rgba(124, 179, 66, 0.3)"}}),f>0&&e.jsx(p,{label:`${f} Grower`,size:"small",sx:{bgcolor:"rgba(124, 179, 66, 0.15)",color:"#9AE66E",border:"1px solid rgba(124, 179, 66, 0.3)"}})]})]})]})]})]})})}function ge({onBack:s,onNavigate:_}){const{user:c}=se(),{proRole:d,proEnabled:i}=ne(),[x,S]=h.useState([]),[l,b]=h.useState([]),[u,j]=h.useState(!0),[g,m]=h.useState(""),[f,r]=h.useState(null),[n,I]=h.useState(""),[E,N]=h.useState(""),[w,U]=h.useState("");h.useEffect(()=>{let o=!1;async function X(){try{j(!0),m("");const F=c?.id||null,W={};i&&(d==="dispensary"||d==="grower")&&(W["X-Pro-Role"]=d);const v=new URLSearchParams;F&&v.append("user_id",F),n&&v.append("role",n),E&&v.append("type",E),w&&v.append("strain",w),v.append("limit","200");const Z=`${ae}/api/scans?${v.toString()}`,A=await fetch(Z,{headers:W});if(!A.ok)throw new Error(`HTTP ${A.status}`);const z=await A.json();o||(S(z.scans||[]),b(z.scans||[]))}catch(F){o||(m(String(F)),console.error("[HistoryPage] Load error",F))}finally{o||j(!1)}}return X(),()=>{o=!0}},[c?.id,n,E,w,d,i]);const Y=o=>{r(o)},G=()=>{r(null)};return f?e.jsx(a,{sx:{minHeight:"100vh",width:"100%",backgroundColor:"#050705",bgcolor:"#0a0f0a",position:"relative"},children:e.jsxs(M,{maxWidth:"md",sx:{pt:"calc(env(safe-area-inset-top) + 20px)",pb:4},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",gap:1},children:[e.jsx(P,{onClick:G,sx:{color:"#C5E1A5"},children:e.jsx(D,{})}),e.jsx(t,{variant:"h6",sx:{color:"#F1F8E9",fontWeight:700},children:"Scan Details"})]}),e.jsx(re,{scan:f,result:f})]})}):e.jsx(a,{sx:{minHeight:"100vh",width:"100%",backgroundColor:"#050705",backgroundImage:"url(/strainspotter-bg.jpg)",backgroundSize:"cover",backgroundPosition:"center",position:"relative"},children:e.jsxs(M,{maxWidth:"md",sx:{pt:"calc(env(safe-area-inset-top) + 20px)",pb:4},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",gap:1},children:[e.jsx(P,{onClick:s,sx:{color:"#C5E1A5"},children:e.jsx(D,{})}),e.jsx(t,{variant:"h4",sx:{color:"#F1F8E9",fontWeight:700},children:"Scan History"})]}),e.jsxs(y,{direction:"row",spacing:1,sx:{mb:3},flexWrap:"wrap",gap:1,children:[e.jsxs(T,{size:"small",sx:{minWidth:120},children:[e.jsx(B,{sx:{color:"rgba(200, 230, 201, 0.7)"},children:"Role"}),e.jsxs(O,{value:n,onChange:o=>I(o.target.value),label:"Role",sx:{color:"#E8F5E9","& .MuiOutlinedInput-notchedOutline":{borderColor:"rgba(124, 179, 66, 0.3)"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"rgba(124, 179, 66, 0.5)"},"& .MuiSvgIcon-root":{color:"rgba(200, 230, 201, 0.7)"}},children:[e.jsx(C,{value:"",children:"All"}),e.jsx(C,{value:"dispensary",children:"Dispensary"}),e.jsx(C,{value:"grower",children:"Grower"})]})]}),e.jsxs(T,{size:"small",sx:{minWidth:120},children:[e.jsx(B,{sx:{color:"rgba(200, 230, 201, 0.7)"},children:"Type"}),e.jsxs(O,{value:E,onChange:o=>N(o.target.value),label:"Type",sx:{color:"#E8F5E9","& .MuiOutlinedInput-notchedOutline":{borderColor:"rgba(124, 179, 66, 0.3)"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"rgba(124, 179, 66, 0.5)"},"& .MuiSvgIcon-root":{color:"rgba(200, 230, 201, 0.7)"}},children:[e.jsx(C,{value:"",children:"All"}),e.jsx(C,{value:"packaged",children:"Packaged"}),e.jsx(C,{value:"bud",children:"Bud"})]})]}),e.jsx(K,{size:"small",placeholder:"Filter by strain...",value:w,onChange:o=>U(o.target.value),sx:{flex:1,minWidth:150,"& .MuiOutlinedInput-root":{color:"#E8F5E9","& fieldset":{borderColor:"rgba(124, 179, 66, 0.3)"},"&:hover fieldset":{borderColor:"rgba(124, 179, 66, 0.5)"},"&.Mui-focused fieldset":{borderColor:"#7CB342"}}}})]}),u&&e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(Q,{sx:{color:"#CDDC39"}})}),g&&e.jsx(V,{severity:"error",sx:{mb:3},children:g}),!u&&!g&&e.jsxs(e.Fragment,{children:[l.length>0&&e.jsx(oe,{scans:l,proRole:d}),l.length===0?e.jsx(a,{sx:{textAlign:"center",py:4},children:e.jsxs(t,{variant:"body1",sx:{color:"rgba(200, 230, 201, 0.7)"},children:["No scans found",n||E||w?" matching filters":"","."]})}):e.jsx(a,{children:l.map(o=>e.jsx(te,{scan:o,onClick:()=>Y(o)},o.id))})]})]})})}export{ge as default};
