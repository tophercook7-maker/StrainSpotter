import{r,j as e,B as l,n as L,T as i,A as g,i as c,S as j,H as w,aM as $,aN as v,a0 as k,f as P,h as S,aO as E,ao as G,an as z}from"./react-vendor-CxfKVgr3.js";import{a as A,C as B}from"./App-JmJcCWdD.js";import{b as R}from"./router-vendor-C0qkbn0g.js";import"./vendor-DCH4KwNm.js";function T({onBack:p}){const C=R(),[u,x]=r.useState([]),[I,h]=r.useState(!0),[m,f]=r.useState(null),[a,b]=r.useState(null),[y,d]=r.useState(null);return r.useEffect(()=>{(async()=>{try{if(window.Capacitor&&window.Capacitor.Plugins&&window.Capacitor.Plugins.Geolocation){const{Geolocation:n}=window.Capacitor.Plugins,o=await n.getCurrentPosition({timeout:15e3,enableHighAccuracy:!1,maximumAge:3e5});console.log("[Dispensaries] Location obtained via Capacitor:",o),b({lat:o.coords.latitude,lng:o.coords.longitude});return}"geolocation"in navigator?navigator.geolocation.getCurrentPosition(n=>{console.log("[Dispensaries] Location obtained successfully"),b({lat:n.coords.latitude,lng:n.coords.longitude})},n=>{console.warn("[Dispensaries] Location access denied:",n.message),n.code===1?d("Location access denied. Please enable location services or search manually."):d("Unable to detect location. Please search manually or enable location services.")},{timeout:15e3,maximumAge:3e5,enableHighAccuracy:!1}):(console.log("[Dispensaries] Geolocation not supported"),d("Geolocation not supported. Please search manually."))}catch(n){console.error("[Dispensaries] Location error:",n),d("Unable to detect location. Please search manually.")}})()},[]),r.useEffect(()=>{if(!a){h(!1);return}const s=new URLSearchParams;s.set("lat",a.lat),s.set("lng",a.lng),s.set("radius","50");const n=`${A}/api/dispensaries?${s}`;console.log("[Dispensaries] Fetching from:",n),fetch(n).then(o=>{if(console.log("[Dispensaries] Response status:",o.status,o.statusText),!o.ok){if(o.status===400)return o.json().then(t=>{throw new Error(t.error||"Location required")});throw new Error("Failed to load dispensaries")}return o.json()}).then(o=>{console.log("[Dispensaries] Received dispensaries:",o?.length||0),a&&Array.isArray(o)&&o.sort((t,D)=>(t.distance||1/0)-(D.distance||1/0)),x(o||[]),f(null)}).catch(o=>{console.error("[Dispensaries] Error:",o),f(o.message||"Failed to load dispensaries. Please try again."),x([])}).finally(()=>h(!1))},[a]),I?e.jsxs(l,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,m:4},children:[e.jsx(L,{}),e.jsx(i,{variant:"body2",color:"text.secondary",children:a?"Finding dispensaries near you...":"Getting your location..."})]}):m?e.jsx(g,{severity:"error",sx:{m:2},children:m}):e.jsxs(l,{sx:{p:3},children:[e.jsxs("button",{style:{position:"absolute",top:16,left:16,zIndex:100,background:"rgba(34, 139, 34, 0.25)",border:"1px solid #228B22",borderRadius:12,boxShadow:"0 2px 12px rgba(34,139,34,0.15)",backdropFilter:"blur(8px)",color:"#228B22",padding:"8px 16px",display:"flex",alignItems:"center",fontWeight:600,fontSize:18},onClick:()=>C("/"),children:[e.jsx(B,{style:{marginRight:8,height:24}}),"Home"]}),p&&e.jsx(l,{sx:{mb:2},children:e.jsx(c,{onClick:p,size:"small",variant:"contained",sx:{bgcolor:"#7CB342",color:"white",textTransform:"none",fontWeight:700,borderRadius:999,"&:hover":{bgcolor:"#689f38"}},children:"â† Back to Garden"})}),e.jsxs(j,{direction:"row",alignItems:"center",spacing:2,sx:{mb:3},children:[e.jsx(i,{variant:"h4",sx:{fontWeight:700},children:"Dispensaries Near You"}),a&&e.jsx(w,{icon:e.jsx($,{}),label:"Location enabled",color:"success",size:"small"})]}),e.jsxs(l,{sx:{mb:4},children:[e.jsx(i,{variant:"h6",sx:{mb:1},children:"Google Maps Results"}),e.jsx(c,{variant:"outlined",color:"primary",startIcon:e.jsx(v,{}),href:a?`https://www.google.com/maps/search/dispensary/@${a.lat},${a.lng},13z`:"https://www.google.com/maps/search/dispensary/",target:"_blank",rel:"noopener noreferrer",sx:{mb:2},children:"View Dispensaries on Google Maps"})]}),y&&e.jsx(g,{severity:"info",sx:{mb:2},children:y}),u.length===0?e.jsx(g,{severity:"info",children:"No dispensaries found nearby. Try expanding your search radius or check back later."}):e.jsx(k,{container:!0,spacing:3,children:u.map((s,n)=>e.jsx(k,{item:!0,size:{xs:12,sm:6,md:4},children:e.jsxs(P,{sx:{mb:2,background:"rgba(255,255,255,0.10)",backdropFilter:"blur(12px)",border:"2px solid black",boxShadow:"none"},children:[e.jsxs(S,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,sx:{fontWeight:600},children:s.name}),s.distance&&e.jsx(w,{label:`${s.distance.toFixed(1)} mi away`,size:"small",color:"primary",sx:{mb:1}}),e.jsxs(j,{spacing:.5,sx:{mt:1},children:[e.jsx(i,{variant:"body2",sx:{color:"black",fontSize:"1.08rem"},children:s.address}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:[s.city,", ",s.state," ",s.zip||""]}),s.description&&e.jsx(i,{variant:"body2",sx:{mt:1},children:s.description})]})]}),e.jsx(l,{sx:{p:2,pt:0},children:e.jsxs(E,{fullWidth:!0,orientation:"vertical",variant:"contained",children:[s.phone&&e.jsxs(c,{startIcon:e.jsx(G,{}),href:`tel:${s.phone.replace(/[^0-9+]/g,"")}`,sx:{background:"linear-gradient(45deg, #4caf50 30%, #66bb6a 90%)","&:hover":{background:"linear-gradient(45deg, #388e3c 30%, #4caf50 90%)"}},children:["Call ",s.phone]}),s.lat&&s.lng||s.address&&s.city&&s.state?e.jsx(c,{startIcon:e.jsx(z,{}),onClick:()=>{const o=s.lat&&s.lng?`${s.lat},${s.lng}`:`${s.address}, ${s.city}, ${s.state} ${s.zip||""}`.trim(),t=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(o)}`;window.open(t,"_blank")},sx:{background:"linear-gradient(45deg, #2196f3 30%, #42a5f5 90%)","&:hover":{background:"linear-gradient(45deg, #1976d2 30%, #2196f3 90%)"}},children:"Get Directions"}):null,s.website&&e.jsx(c,{startIcon:e.jsx(v,{}),href:s.website,target:"_blank",rel:"noopener noreferrer",sx:{background:"linear-gradient(45deg, #ff9800 30%, #ffa726 90%)","&:hover":{background:"linear-gradient(45deg, #f57c00 30%, #ff9800 90%)"}},children:"Visit Website"})]})})]})},`${s.id}-${n}`))})]})}export{T as default};
