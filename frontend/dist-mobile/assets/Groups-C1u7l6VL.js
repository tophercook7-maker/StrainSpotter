import{r as t,j as e,D as ze,p as Ue,q as Ge,S as A,T as d,m as ue,u as cr,i as T,B as c,M as Ce,a4 as pr,ay as dr,I as de,y as ds,az as us,ai as Rr,aA as gs,aB as ps,O as hs,aC as Lr,aD as zr,A as Ie,o as lr,f as fs,k as xs,l as Fr,aE as ms,h as bs,aF as ys,aG as Wr,aH as Cs,aI as js,aJ as Br,aK as ws,aL as Ss,s as ks,t as vs,as as Ds}from"./react-vendor-CxfKVgr3.js";import{B as _s}from"./BackHeader-jnSvreF0.js";import{u as Oe,a as k,s as N}from"./App-JmJcCWdD.js";import"./vendor-DCH4KwNm.js";function Ms({open:o,email:l,initialDisplayName:b="",saving:g=!1,error:h="",onSave:x,onClose:C}){const[F,$]=t.useState(b);t.useEffect(()=>{o&&$(b||"")},[o,b]);const a=()=>{const D=F.trim();!D||D.length<2||x?.({displayName:D})};return e.jsxs(ze,{open:o,onClose:C,maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ue,{sx:{fontWeight:700,color:"#2e7d32"},children:"Complete Your Profile"}),e.jsx(Ge,{children:e.jsxs(A,{spacing:2,sx:{mt:1},children:[e.jsx(d,{variant:"body2",sx:{color:"text.secondary"},children:"Pick the name other members will see in groups and direct messages. You can change this anytime."}),e.jsx(ue,{label:"Display Name",value:F,onChange:D=>$(D.target.value),placeholder:"e.g. Topher",required:!0,inputProps:{maxLength:60}}),e.jsx(ue,{label:"Email",value:l||"",InputProps:{readOnly:!0}}),h&&e.jsx(d,{variant:"body2",sx:{color:"#d32f2f"},children:h})]})}),e.jsxs(cr,{sx:{px:3,pb:2},children:[e.jsx(T,{onClick:C,disabled:g,children:"Not now"}),e.jsx(T,{variant:"contained",onClick:a,disabled:g,children:g?"Saving...":"Save"})]})]})}function Le(o,l,b){if(l==="group")return{id:o.id,groupId:o.group_id,senderId:o.sender_user_id,senderName:o.users?.display_name||o.users?.username||"User",senderAvatarUrl:o.users?.avatar_url||null,text:o.body,attachments:o.image_url?[{type:"image",url:o.image_url}]:[],createdAt:o.created_at,isSystem:!1,isPinned:o.is_pinned||!1,raw:o};{const g=Array.isArray(o.attachments)?o.attachments:o.image_url?[{type:"image",url:o.image_url}]:[];return{id:o.id,dmId:o.conversation_id,senderId:o.sender_id||o.sender_user_id,senderName:o.sender?.display_name||o.sender?.username||o.profiles?.display_name||o.profiles?.username||"User",senderAvatarUrl:o.sender?.avatar_url||o.profiles?.avatar_url||null,text:o.text||o.body||"",attachments:g,createdAt:o.created_at,isSystem:!1,raw:o}}}function Pr({mode:o,id:l}){const{session:b}=Oe(),[g,h]=t.useState([]),[x,C]=t.useState([]),[F,$]=t.useState(!0),[a,D]=t.useState(!1),[u,R]=t.useState(!1),[_,G]=t.useState(null),[K,Y]=t.useState(null),j=t.useRef(null),B=t.useRef(null),X=t.useRef(!0),L=t.useRef(!0),ne=t.useCallback(()=>{if(!B.current)return;const p=B.current,w=p.scrollHeight-(p.scrollTop+p.clientHeight);X.current=w<200},[]),J=t.useCallback((p="smooth")=>{j.current&&j.current.scrollIntoView({behavior:p,block:"end"})},[]);t.useEffect(()=>{if(!l||!b?.access_token){h([]),C([]),$(!1);return}let p=!1;$(!0),Y(null),L.current=!0;const w=b.access_token,S=o==="group"?`${k}/api/groups/${l}/messages?limit=50`:`${k}/api/dm/${l}/messages?limit=50`;return fetch(S,{headers:{Authorization:`Bearer ${w}`,"Content-Type":"application/json"}}).then(async m=>m.ok?m.json():(console.error("[useInfiniteMessages] Failed to load messages",m.status,m.statusText),p||(Y(new Error(`Failed to load messages (${m.status})`)),$(!1),R(!1)),{messages:[],pinned:[],hasMore:!1,error:"unavailable"})).then(m=>{if(p)return;m.error&&console.warn("[useInfiniteMessages] backend indicated error",m.error);const I=(m.messages||[]).map(W=>Le(W,o,b?.user?.id));if(I.sort((W,M)=>new Date(W.createdAt)-new Date(M.createdAt)),h(I),o==="group"&&m.pinned){const W=(m.pinned||[]).map(M=>Le(M,o,b?.user?.id));C(W)}R(m.hasMore||!1),G(m.nextCursor||null),setTimeout(()=>{J("auto"),X.current=!0},100)}).catch(m=>{console.error("[useInfiniteMessages] error",m),p||(h([]),R(!1),Y("Unable to load messages"))}).finally(()=>{p||$(!1)}),()=>{p=!0}},[l,o,b]);const ge=t.useCallback(async()=>{if(!l||!b?.access_token||a||!u||!_)return;D(!0),Y(null);const p=B.current,w=p?p.scrollHeight:0,S=b.access_token,m=o==="group"?`${k}/api/groups/${l}/messages?limit=50&before=${encodeURIComponent(_)}`:`${k}/api/dm/${l}/messages?limit=50&before=${encodeURIComponent(_)}`;try{const f=await fetch(m,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json"}});if(!f.ok){const M=await f.text().catch(()=>"");throw new Error(`Failed to load more messages: ${f.status} ${M}`)}const I=await f.json(),W=(I.messages||[]).map(M=>Le(M,o,b?.user?.id));if(W.sort((M,z)=>new Date(M.createdAt)-new Date(z.createdAt)),h(M=>[...W,...M].reduce((P,U)=>(P.find(V=>V.id===U.id)||P.push(U),P),[]).sort((P,U)=>new Date(P.createdAt)-new Date(U.createdAt))),R(I.hasMore||!1),G(I.nextCursor||null),p){const z=p.scrollHeight-w;p.scrollTop+=z}}catch(f){console.error("[useInfiniteMessages] loadMore error",f),Y(f?.message||"Failed to load more messages")}finally{D(!1)}},[l,o,b,a,u,_]),Q=t.useCallback(p=>{const w=Le(p,o,b?.user?.id);h(S=>S.find(m=>m.id===w.id)?S:[...S,w].sort((m,f)=>new Date(m.createdAt)-new Date(f.createdAt))),X.current&&setTimeout(()=>{J("smooth")},100)},[o,b,J]);return{messages:g,pinnedMessages:x,isLoadingInitial:F,isLoadingMore:a,hasMore:u,error:K,loadMore:ge,scrollToBottomRef:j,scrollContainerRef:B,onNewMessage:Q,scrollToBottom:J,handleScroll:ne}}function Is({scope:o,id:l,currentUserId:b}){const{session:g}=Oe(),[h,x]=t.useState([]),C=t.useRef(null),F=t.useRef(0);t.useEffect(()=>{if(!l||!o||!g?.access_token){x([]);return}const a=async()=>{try{const u=g.access_token,R=await fetch(`${k}/api/chat/typing?scope=${o}&id=${l}`,{headers:{Authorization:`Bearer ${u}`,"Content-Type":"application/json"}});if(R.ok){const _=await R.json();x(_.users||[])}}catch(u){console.error("[useTypingIndicator] poll error",u)}};a();const D=setInterval(a,3e3);return()=>clearInterval(D)},[l,o,g]);const $=t.useCallback(()=>{if(!l||!o||!g?.access_token||!b)return;const a=Date.now();if(a-F.current<2e3)return;C.current&&clearTimeout(C.current);const D=g.access_token;fetch(`${k}/api/chat/typing`,{method:"POST",headers:{Authorization:`Bearer ${D}`,"Content-Type":"application/json"},body:JSON.stringify({scope:o,id:l,isTyping:!0})}).catch(u=>{console.error("[useTypingIndicator] notifyTyping error",u)}),F.current=a,C.current=setTimeout(()=>{fetch(`${k}/api/chat/typing`,{method:"POST",headers:{Authorization:`Bearer ${D}`,"Content-Type":"application/json"},body:JSON.stringify({scope:o,id:l,isTyping:!1})}).catch(u=>{console.error("[useTypingIndicator] stopTyping error",u)})},5e3)},[l,o,g,b]);return t.useEffect(()=>()=>{C.current&&clearTimeout(C.current),l&&o&&g?.access_token&&b&&fetch(`${k}/api/chat/typing`,{method:"POST",headers:{Authorization:`Bearer ${g.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({scope:o,id:l,isTyping:!1})}).catch(()=>{})},[l,o,g,b]),{typingUsers:h,notifyTyping:$}}function Ts(o){if(!o)return"";const l=new Date(o),g=new Date-l,h=Math.floor(g/6e4);if(h<1)return"now";if(h<60)return`${h}m`;const x=Math.floor(h/60);if(x<24)return`${x}h`;const C=Math.floor(x/24);return C<7?`${C}d`:l.toLocaleDateString()}function As(o){return o?o.length>50?`${o.slice(0,47)}â€¦`:o:"No messages yet"}function $s({groups:o,selectedGroupId:l,onSelectGroup:b,isLoading:g}){return g?e.jsx(c,{sx:{p:2,textAlign:"center"},children:e.jsx(d,{variant:"body2",sx:{color:"rgba(255,255,255,0.5)"},children:"Loading groups..."})}):!o||o.length===0?e.jsx(c,{sx:{p:2,textAlign:"center"},children:e.jsx(d,{variant:"body2",sx:{color:"rgba(255,255,255,0.5)"},children:"No groups available"})}):e.jsx(c,{sx:{flex:1,overflowY:"auto",WebkitOverflowScrolling:"touch",padding:1},children:e.jsx(A,{spacing:.5,children:o.map(h=>{const x=h.id===l,C=h.last_message,F=h.unread_count||0;return e.jsxs(c,{onClick:()=>b?.(h),sx:{display:"flex",alignItems:"center",gap:1.5,padding:"10px 12px",borderRadius:2,cursor:"pointer",backgroundColor:x?"rgba(124, 179, 66, 0.15)":"transparent",border:x?"1px solid rgba(124, 179, 66, 0.3)":"1px solid transparent","&:hover":{backgroundColor:x?"rgba(124, 179, 66, 0.2)":"rgba(255,255,255,0.06)"},transition:"background-color 0.2s"},children:[e.jsx(Ce,{sx:{width:40,height:40,bgcolor:"rgba(124, 179, 66, 0.3)",color:"#CDDC39",flexShrink:0},children:e.jsx(pr,{})}),e.jsxs(c,{sx:{flex:1,minWidth:0},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(d,{variant:"subtitle2",sx:{fontWeight:600,color:"#F1F8E9",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:h.name}),C&&e.jsx(d,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.7rem",flexShrink:0,ml:1},children:Ts(C.created_at)})]}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(d,{variant:"caption",sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.75rem",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:C?`${C.user?.display_name||C.user?.username||"Someone"}: ${As(C.content)}`:"No messages yet"}),F>0&&e.jsx(dr,{badgeContent:F,sx:{"& .MuiBadge-badge":{bgcolor:"#7CB342",color:"#0c220f",fontWeight:700,fontSize:"0.65rem",minWidth:"18px",height:"18px"}}})]})]})]},h.id)})})})}function ur({group:o,memberCount:l,onBack:b,onMenu:g,isMobile:h=!1,typingUsers:x=[]}){return e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1.5,paddingX:1.5,paddingY:1,paddingTop:"calc(env(safe-area-inset-top, 0px) + 8px)",borderBottom:"1px solid rgba(255,255,255,0.08)",flexShrink:0,backgroundColor:"transparent",backdropFilter:"blur(10px)",minHeight:44,maxHeight:44},children:[b&&e.jsx(de,{onClick:b,sx:{color:"#CDDC39","&:hover":{bgcolor:"rgba(124,179,66,0.1)"}},children:e.jsx(ds,{})}),e.jsx(c,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"rgba(124, 179, 66, 0.3)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(pr,{sx:{color:"#CDDC39"}})}),e.jsxs(c,{sx:{flex:1,minWidth:0},children:[e.jsx(d,{variant:"subtitle1",sx:{fontWeight:600,color:"#F1F8E9",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:o?.name||"Group"}),e.jsxs(d,{variant:"caption",sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.75rem"},children:[l||0," member",l!==1?"s":""]}),x.length>0&&e.jsx(d,{variant:"caption",sx:{color:"#9CCC65",fontSize:"0.7rem",fontStyle:"italic",mt:.25},children:x.length===1?`${x[0].displayName} is typingâ€¦`:"Several people are typingâ€¦"})]}),g&&e.jsx(de,{onClick:g,sx:{color:"#9CCC65","&:hover":{bgcolor:"rgba(124,179,66,0.1)"}},children:e.jsx(us,{})})]})}function gr({value:o,onChange:l,onSend:b,onAttach:g,disabled:h,sending:x,placeholder:C="Type a messageâ€¦",showAttach:F=!1,replyToMessage:$=null,onCancelReply:a=null,notifyTyping:D=null,scope:u="group",channelId:R=null}){const[_,G]=t.useState([]),[K,Y]=t.useState(!1),j=t.useRef(null),B=p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),(o.trim()||_.length>0)&&!h&&!x&&!K&&J())},X=p=>{l?.(p),D&&p.trim()&&D()},L=()=>{j.current?.click()},ne=async p=>{const w=p.target.files?.[0];if(w){if(!w.type.startsWith("image/")){alert("Please select an image file");return}if(w.size>8*1024*1024){alert("Image must be smaller than 8MB");return}if(!R){alert("Channel ID is required for uploads");return}Y(!0);try{const S=w.name.split(".").pop()||"jpg",m=`${crypto.randomUUID()}.${S}`,f=`${u}/${R}/${m}`,{data:I,error:W}=await N.storage.from("chat-attachments").upload(f,w,{contentType:w.type,cacheControl:"3600"});if(W){console.error("[ChatInput] Upload error",W),alert("Failed to upload image. Please try again.");return}const{data:M}=N.storage.from("chat-attachments").getPublicUrl(f),z=new Image;z.src=M.publicUrl,await new Promise((P,U)=>{z.onload=()=>P({width:z.width,height:z.height}),z.onerror=U});const je={type:"image",url:M.publicUrl,width:z.width,height:z.height};G(P=>[...P,je])}catch(S){console.error("[ChatInput] File handling error",S),alert("Failed to process image. Please try again.")}finally{Y(!1),j.current&&(j.current.value="")}}},J=()=>{!o.trim()&&_.length===0||h||x||K||(b?.(o,_.length>0?_:null),l?.(""),G([]),a&&a())},ge=p=>{G(w=>w.filter((S,m)=>m!==p))},Q=(o.trim()||_.length>0)&&!h&&!x&&!K;return e.jsxs(c,{sx:{borderTop:"1px solid rgba(255,255,255,0.08)",padding:1.5,flexShrink:0,backgroundColor:"transparent",backdropFilter:"blur(10px)"},children:[$&&e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mb:1,p:1,borderRadius:1,bgcolor:"rgba(124,179,66,0.15)",borderLeft:"3px solid rgba(124,179,66,0.5)"},children:[e.jsxs(c,{sx:{flex:1,minWidth:0},children:[e.jsxs(d,{variant:"caption",sx:{fontWeight:600,color:"#CDDC39",display:"block"},children:["Replying to ",$.senderName||$.sender?.display_name||"someone"]}),e.jsx(d,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.7rem",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block"},children:$.text||$.body||$.content||""})]}),a&&e.jsx(de,{size:"small",onClick:a,sx:{color:"#9CCC65","&:hover":{bgcolor:"rgba(124,179,66,0.2)"}},children:e.jsx(Rr,{fontSize:"small"})})]}),_.length>0&&e.jsx(c,{sx:{mb:1,display:"flex",gap:1,flexWrap:"wrap"},children:_.map((p,w)=>e.jsxs(c,{sx:{position:"relative",width:60,height:60,borderRadius:1,overflow:"hidden",border:"1px solid rgba(255,255,255,0.2)"},children:[e.jsx("img",{src:p.url,alt:"Attachment preview",style:{width:"100%",height:"100%",objectFit:"cover"}}),e.jsx(de,{size:"small",onClick:()=>ge(w),sx:{position:"absolute",top:0,right:0,bgcolor:"rgba(124, 179, 66, 0.2)",color:"#fff",width:20,height:20,"&:hover":{bgcolor:"rgba(124, 179, 66, 0.3)"}},children:e.jsx(Rr,{sx:{fontSize:"0.75rem"}})})]},w))}),e.jsxs(A,{direction:"row",spacing:1,alignItems:"flex-end",children:[e.jsx("input",{ref:j,type:"file",accept:"image/*",style:{display:"none"},onChange:ne}),e.jsx(de,{onClick:L,disabled:h||K||!R,sx:{color:"#9CCC65","&:hover":{bgcolor:"rgba(124,179,66,0.1)"},"&:disabled":{opacity:.5}},children:e.jsx(gs,{})}),F&&g&&e.jsx(de,{onClick:g,disabled:h,sx:{color:"#9CCC65","&:hover":{bgcolor:"rgba(124,179,66,0.1)"}},children:e.jsx(ps,{})}),e.jsx(ue,{fullWidth:!0,multiline:!0,maxRows:4,value:o,onChange:p=>X(p.target.value),onKeyDown:B,placeholder:C,disabled:h||K,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{bgcolor:"rgba(255,255,255,0.05)",borderRadius:3,border:"1px solid rgba(255,255,255,0.1)",color:"#F1F8E9","&:hover":{borderColor:"rgba(124,179,66,0.3)"},"&.Mui-focused":{borderColor:"rgba(124,179,66,0.5)",bgcolor:"rgba(255,255,255,0.08)"},"& fieldset":{border:"none"}},"& .MuiInputBase-input":{padding:"10px 14px",fontSize:"0.9rem","&::placeholder":{color:"rgba(255,255,255,0.4)",opacity:1}}}}),e.jsx(de,{onClick:J,disabled:!Q,sx:{color:Q?"#7CB342":"rgba(255,255,255,0.3)",bgcolor:Q?"rgba(124,179,66,0.2)":"transparent","&:hover":{bgcolor:Q?"rgba(124,179,66,0.3)":"transparent"},"&:disabled":{opacity:.5}},children:e.jsx(hs,{})})]}),K&&e.jsx(d,{variant:"caption",sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.7rem",mt:.5,display:"block"},children:"Uploading image..."})]})}function Rs(o){if(!o)return"";const l=new Date(o),g=new Date-l,h=Math.floor(g/6e4);if(h<1)return"just now";if(h<60)return`${h}m ago`;const x=Math.floor(h/60);if(x<24)return`${x}h ago`;const C=Math.floor(x/24);return C<7?`${C}d ago`:l.toLocaleDateString()}function Fs(o){return o.slice(0,2).toUpperCase()}function Er({messages:o,pinnedMessages:l,isLoadingInitial:b,isLoadingMore:g,hasMore:h,onLoadMore:x,scrollContainerRef:C,scrollToBottomRef:F,onScroll:$,currentUserId:a,onReply:D=null,group:u,onBack:R,onSend:_,typingUsers:G=[]}){const{user:K}=Oe(),Y=a||K?.id,j=Lr(),B=zr(j.breakpoints.down("md")),[X,L]=t.useState(null),ne=()=>L(null),J=(S,m)=>{_&&(_(S,m,X),ne())},ge=t.useRef(null),Q=t.useRef(0),p=t.useRef(0),w=b;return!w&&(!o||o.length===0)?e.jsxs(c,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden",bgcolor:"#0a0f0a"},children:[u&&e.jsx(ur,{group:u,onBack:R,typingUsers:G,isMobile:B}),e.jsx(c,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:3,textAlign:"center"},children:e.jsxs(c,{children:[e.jsx(d,{variant:"body2",sx:{color:"#9CCC65",mb:1},children:"Couldn't load messages right now. You can still send a new one."}),_&&e.jsx(d,{variant:"caption",sx:{color:"#7CB342"},children:"Try sending a message to refresh the conversation."})]})}),u&&_&&e.jsx(gr,{value:"",onChange:()=>{},onSend:J,disabled:!1,sending:!1,placeholder:"Type a messageâ€¦",replyToMessage:X,onCancelReply:ne,scope:"group",channelId:u.id})]}):e.jsxs(c,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden",bgcolor:"#0a0f0a",width:"100%"},children:[u&&e.jsx(ur,{group:u,onBack:R,typingUsers:G,isMobile:B}),e.jsxs(c,{sx:{flex:1,minHeight:0,overflowY:"auto",WebkitOverflowScrolling:"touch",paddingBottom:"16px"},ref:C,onScroll:$,children:[w&&(!o||o.length===0)&&e.jsx(c,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",p:2,color:"#9CCC65"},children:"Loading messagesâ€¦"}),!w&&(!o||o.length===0)&&e.jsx(c,{sx:{p:2,color:"#9CCC65",textAlign:"center",mt:2},children:"No messages yet. Be the first to say hi ðŸ‘‹"}),h&&e.jsx(c,{sx:{mb:2,display:"flex",justifyContent:"center",pt:2},children:e.jsx(T,{onClick:x,disabled:g,variant:"outlined",size:"small",sx:{color:"#9CCC65",borderColor:"rgba(124,179,66,0.4)","&:hover":{borderColor:"rgba(124,179,66,0.6)",bgcolor:"rgba(124,179,66,0.1)"}},children:g?"Loadingâ€¦":"Load earlier messages"})}),l&&l.length>0&&e.jsxs(c,{sx:{mb:2,p:1.5,borderRadius:2,bgcolor:"rgba(205, 220, 57, 0.15)",border:"2px solid rgba(205, 220, 57, 0.4)"},children:[e.jsx(d,{variant:"subtitle2",sx:{color:"#CDDC39",fontWeight:700,mb:1,fontSize:"0.75rem"},children:"ðŸ“Œ Pinned Messages"}),e.jsx(A,{spacing:1,children:l.slice(0,3).map(S=>e.jsx(d,{variant:"caption",sx:{color:"#F1F8E9",fontSize:"0.75rem",display:"block"},children:S.body||S.text||S.content},S.id))})]}),e.jsx(A,{spacing:1,sx:{px:2},children:(Array.isArray(o)?o:[]).filter(S=>!S.isPinned&&!S.pinned_at).map((S,m)=>{const f=S.raw||S,I=f.sender_user_id===Y||f.senderId===Y,W=f.senderName||f.users?.display_name||f.users?.username||f.sender?.display_name||f.sender?.username||"User",M=f.text||f.body||f.content||"",z=f.createdAt||f.created_at,je=f.senderAvatarUrl||f.users?.avatar_url||f.sender?.avatar_url||null,P=m>0?o[m-1]:null,U=P?.raw||P,V=U&&(U.sender_user_id===f.sender_user_id||U.senderId===f.senderId),we=!I&&(!V||m===0),pe=!I&&!V,He=Z=>{!B||!D||I||(Q.current=Z.touches[0].clientX,p.current=Z.touches[0].clientY)},E=Z=>{if(!B||!D||I)return;const ie=Z.changedTouches[0].clientX-Q.current,he=Math.abs(Z.changedTouches[0].clientY-p.current);ie>40&&he<50&&D(S)};return e.jsxs(c,{onTouchStart:He,onTouchEnd:E,sx:{display:"flex",justifyContent:I?"flex-end":"flex-start",paddingX:1,paddingY:we?.5:.25,cursor:B&&!I&&D?"grab":"default",userSelect:"none"},children:[!I&&e.jsx(Ce,{sx:{width:32,height:32,bgcolor:"rgba(124, 179, 66, 0.3)",color:"#CDDC39",mr:1,flexShrink:0,display:we?"flex":"none"},src:je,children:Fs(W)}),e.jsxs(c,{sx:{maxWidth:"75%",minWidth:"120px"},children:[pe&&e.jsx(d,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.7rem",fontWeight:600,mb:.25,display:"block"},children:W}),e.jsxs(c,{sx:{borderRadius:3,padding:"8px 12px",backgroundColor:I?"rgba(124, 179, 66, 0.25)":"rgba(255, 255, 255, 0.08)",border:I?"1px solid rgba(124, 179, 66, 0.3)":"1px solid rgba(255, 255, 255, 0.1)",backdropFilter:"blur(10px)"},children:[M&&e.jsx(d,{variant:"body2",sx:{color:"#F1F8E9",whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"0.9rem",lineHeight:1.4},children:M}),f.image_url&&e.jsx(c,{sx:{mt:M?1:0},children:e.jsx("img",{src:f.image_url,alt:"Attachment",style:{maxWidth:"100%",borderRadius:"8px",display:"block"}})}),f.attachments&&Array.isArray(f.attachments)&&f.attachments.length>0&&e.jsx(c,{sx:{mt:M?1:0,display:"flex",flexDirection:"column",gap:1},children:f.attachments.map((Z,ie)=>Z.type==="image"&&Z.url?e.jsx(c,{sx:{borderRadius:2,overflow:"hidden",border:"1px solid rgba(255,255,255,0.1)"},children:e.jsx("img",{src:Z.url,alt:"Message attachment",style:{maxWidth:"100%",height:"auto",display:"block"}})},ie):null)}),e.jsxs(d,{variant:"caption",sx:{display:"block",textAlign:I?"right":"left",color:"rgba(255,255,255,0.5)",fontSize:"0.65rem",marginTop:.25},children:[Rs(z),f.optimistic&&" â€¢ sendingâ€¦"]})]})]})]},f.id||m)})}),e.jsx("div",{ref:ge,"data-scroll-anchor":"group-messages-end",style:{height:1}}),F&&e.jsx("div",{ref:F})]}),u&&_&&e.jsx(gr,{value:"",onChange:()=>{},onSend:J,disabled:!1,sending:!1,placeholder:"Type a messageâ€¦",replyToMessage:X,onCancelReply:ne,scope:"group",channelId:u.id})]})}function Hs({userId:o,onNavigate:l,onBack:b}){const{user:g}=Oe();Lr();const h=zr("(max-width:900px)"),[x,C]=t.useState([]),[F,$]=t.useState(!1),[a,D]=t.useState(o||g?.id||null),[u,R]=t.useState(null),[_,G]=t.useState(!1),[K,Y]=t.useState([]),j=Pr({mode:"group",id:u?.id||null}),B=Is({scope:"group",id:u?.id||null,currentUserId:a}),[X,L]=t.useState([]),[ne,J]=t.useState([]),[ge,Q]=t.useState("consumer"),[p,w]=t.useState(""),[S,m]=t.useState(!1),[f,I]=t.useState(""),[W,M]=t.useState(null),[z,je]=t.useState([]),[P,U]=t.useState(!0),[V,we]=t.useState(0),[pe,He]=t.useState([]),[E,Z]=t.useState(null),[ie,he]=t.useState(!1),[Ur,Gr]=t.useState(null),[hr,Or]=t.useState([]),O=Pr({mode:"dm",id:Ur||null}),[Ws,le]=t.useState([]),[Se,Te]=t.useState(null),[fe,fr]=t.useState(!1),[ke,Hr]=t.useState(""),[ve,Nr]=t.useState("recent");g?.email==="topher.cook7@gmail.com"||g?.email==="strainspotter25@gmail.com"||g?.email==="admin@strainspotter.com"||g?.email;const[Bs,Ps]=t.useState(!1),Yr=["Growers","Budtenders","Medical","Recreational","Local Chat","General","Dispensary Owners","Seed Swap","Events","Help & Advice"],[Ne,Ye]=t.useState(!1),[Jr,Je]=t.useState(!1),[Ae,qr]=t.useState(null),[xr,Kr]=t.useState("inappropriate"),[mr,br]=t.useState(""),[Xr,$e]=t.useState(!1),[yr,Vr]=t.useState(!1),[xe,Cr]=t.useState(!1),[qe,Re]=t.useState({open:!1,message:"",severity:"success"}),Ke=t.useMemo(()=>`ss_guidelines_accepted_${a||"guest"}`,[a]),jr=(r,s)=>{s!=="clickaway"&&Re(n=>({...n,open:!1}))},me=t.useCallback(r=>(r||"").toString().toLowerCase().trim(),[]),Fe=t.useCallback(r=>r?.display_name||r?.username||(r?.email?r.email.split("@")[0]:null)||"User",[]),Xe=t.useMemo(()=>{const r=me(ke);return r?pe.filter(s=>me(Fe(s.user)).includes(r)):pe},[pe,ke,me,Fe]),Ve=t.useMemo(()=>{const r=me(ke),s=hr.map(n=>({...n,_label:Fe(n)})).sort((n,i)=>n._label.localeCompare(i._label));return r?s.filter(n=>me(n._label).includes(r)):s},[hr,ke,me,Fe]),[Es,Qr]=t.useState(null),[Ls,wr]=t.useState(null),[Qe,Sr]=t.useState(null),[Zr,De]=t.useState(!1),[es,kr]=t.useState(!1),[rs,vr]=t.useState(""),[Ze,er]=t.useState(!1),rr=t.useCallback(async()=>{if(a)try{const{data:{session:r}}=await N.auth.getSession(),s=r?.access_token;if(!s)return;await fetch(`${k}/api/users/heartbeat`,{method:"POST",headers:{Authorization:`Bearer ${s}`}})}catch(r){console.error("[Groups] Heartbeat failed:",r)}},[a]),ss=t.useCallback(r=>{if(!r)return"";const s=new Date(r),n=(Date.now()-s.getTime())/1e3;if(n<45)return"just now";if(n<90)return"1 min ago";const i=n/60;if(i<60)return`${Math.round(i)} min ago`;const y=i/60;if(y<24)return`${Math.round(y)} hr${Math.round(y)===1?"":"s"} ago`;const v=y/24;return v<30?`${Math.round(v)} day${Math.round(v)===1?"":"s"} ago`:s.toLocaleDateString()},[]),ts=t.useCallback(r=>r?r.length>90?`${r.slice(0,87)}â€¦`:r:"",[]),[be,Dr]=t.useState("You"),_r=t.useCallback((r,s,n)=>{const i=(r?.display_name||"").trim();if(!i||i.length<3)return!0;const y=i.toLowerCase(),v=s?s.split("@")[0].toLowerCase():"",ee=v.replace(/[^a-z]/g,"");return!!([v,ee,`user_${(n||"").slice(0,8)}`.toLowerCase(),`user ${(n||"").slice(0,8)}`.toLowerCase(),`member ${(n||"").slice(0,8)}`.toLowerCase()].includes(y)||y.includes("@")||/_/.test(y)||/[0-9]{3,}/.test(y))},[]),sr=t.useCallback((r,s,n)=>r?.display_name?r.display_name:r?.username?r.username:s==="topher.cook7@gmail.com"?"Topher":s?s.split("@")[0]:n?`Member ${n.slice(0,8)}`:"You",[]);t.useEffect(()=>{if(o){D(o);return}if(g?.id){D(g.id),console.log("[Groups] Using auth context user:",g.email);return}let r;return(async()=>{try{if(!N)return;const{data:s}=await N.auth.getSession(),n=s?.session?.user?.id||null;console.log("[Groups] Session user ID:",n),D(n)}catch{console.error("Groups: getSession failed")}})(),N&&(r=N.auth.onAuthStateChange((n,i)=>{D(i?.user?.id||null)})?.data?.subscription),()=>r?.unsubscribe?.()},[o,g]),t.useEffect(()=>{if(!a)return;rr();const r=setInterval(()=>{rr()},6e4);return()=>clearInterval(r)},[a,rr]);const tr=t.useRef(!1),or=t.useRef(null),We=t.useCallback(async()=>{try{U(!0),console.log("[Groups] Fetching from:",`${k}/api/groups`);const r=await fetch(`${k}/api/groups`);if(console.log("[Groups] Response status:",r.status,r.statusText),r.ok){const s=await r.json();console.log("[Groups] Received groups:",s?.length||0);const n=Array.isArray(s)?s.filter(i=>Yr.includes(i.name)):[];console.log("[Groups] Filtered groups:",n?.length||0),C(n||[]),$(!0),Qr(i=>!i&&Array.isArray(s)&&s.length?s[0]?.admin_user_id||null:i)}else console.error("[Groups] Failed to fetch groups:",r.status,r.statusText),C([])}catch(r){console.error("[Groups] Fetch error:",r),C([])}finally{U(!1)}},[]);t.useEffect(()=>{if(!a){U(!1),tr.current=!1,or.current=null;return}tr.current&&or.current===a||(tr.current=!0,or.current=a,We())},[a,We]),t.useEffect(()=>{a&&(async()=>{try{console.log("[Groups] Auto-setting up user account for:",a);const{data:{session:r}}=await N.auth.getSession(),s=r?.user?.email;if(s){const{data:n}=await N.from("profiles").select("display_name, username, email, role").eq("user_id",a).single(),i=n?{...n,email:n.email??s}:{display_name:null,username:null,email:s,role:"consumer"};Sr(i),Q(n?.role||"consumer");const y=sr(i,s,a);Dr(y),!Ze&&_r(i,s,a)&&De(!0),console.log("[Groups] Ensuring user record exists for:",a,s),(await fetch(`${k}/api/users/ensure`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a,email:s,username:y})})).ok&&console.log("[Groups] User account ready")}else Ze||De(!0)}catch(r){console.error("[Groups] Auto-setup error:",r)}})()},[a,Ze,sr,_r]),t.useEffect(()=>{localStorage.getItem(Ke)==="true"&&Cr(!0)},[Ke]);const Be=t.useCallback(async r=>{try{console.log("ðŸ“¥ Loading messages for group:",r),console.log("ðŸ“¥ API URL:",`${k}/api/groups/${r}/messages`);const s=await fetch(`${k}/api/groups/${r}/messages`);if(console.log("ðŸ“¥ Load messages response:",s.status,s.ok),s.ok){const n=await s.json();Array.isArray(n)?(L(n),J([])):(L(n.messages||[]),J(n.pinnedMessages||[])),console.log("ðŸ“¥ Loaded messages:",(n.messages||n).length,"messages"),console.log("ðŸ“¥ Loaded pinned messages:",(n.pinnedMessages||[]).length),wr(new Date)}else console.error("âŒ Failed to load messages:",s.status,s.statusText)}catch(s){console.error("âŒ Error loading messages:",s)}},[]);t.useEffect(()=>{if(!u||!_){L([]);return}console.log("ðŸ”„ Starting auto-refresh for group:",u.id);const r=setInterval(()=>{console.log("ðŸ”„ Auto-refreshing messages..."),u?.id&&_&&Be(u.id)},3e3);return()=>{console.log("ðŸ›‘ Stopping auto-refresh"),clearInterval(r),L([])}},[u?.id,_,Be]),t.useEffect(()=>{ie&&E&&le(O.messages.map(r=>r.raw||r))},[O.messages,ie,E]);const ce=t.useCallback(async()=>{if(a)try{const r=await fetch(`${k}/api/direct-chats/chats/${a}`);if(r.ok){const s=await r.json();He(s)}}catch(r){console.error("Failed to load direct chats:",r)}},[a]),nr=t.useCallback(async r=>{if(a)try{console.log("ðŸ’¬ Loading direct messages with user:",r);const s=await fetch(`${k}/api/direct-messages/${a}/${r}`);if(console.log("ðŸ’¬ Direct messages response:",s.status),s.ok){const n=await s.json();console.log("ðŸ’¬ Loaded direct messages:",n.length),le(n),wr(new Date)}}catch(s){console.error("Failed to load direct messages:",s)}},[a]),_e=t.useCallback(async r=>{console.log("ðŸ’¬ Starting direct chat with:",r.display_name||r.username,r.user_id),Z(r),le([]),he(!0);try{const{data:{session:s}}=await N.auth.getSession(),n=s?.access_token;if(n&&a){const i=await fetch(`${k}/api/dm/start`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({userId:r.user_id})});if(i.ok){const y=await i.json();Gr(y.conversation_id||y.id)}}}catch(s){console.error("Failed to get conversation ID:",s)}if(await nr(r.user_id),a)try{await fetch(`${k}/api/direct-messages/mark-read/${a}/${r.user_id}`,{method:"PUT"}),ce()}catch(s){console.error("Failed to mark messages as read:",s)}},[a,nr,ce]);t.useEffect(()=>{if(V===1&&a){const r=setInterval(()=>{ce()},5e3);return()=>clearInterval(r)}},[V,a,ce]),t.useEffect(()=>{if(V===1&&a){console.log("ðŸ”„ Direct Messages tab activated, loading users..."),console.log("ðŸ”„ API_BASE:",k),console.log("ðŸ”„ userId:",a),ar(),ce();const r=sessionStorage.getItem("openDMWith");if(r)try{const s=JSON.parse(r);sessionStorage.removeItem("openDMWith"),setTimeout(()=>{_e&&(_e(s),we(1))},1e3)}catch(s){console.error("Failed to parse openDMWith:",s)}}},[V,a,ce,_e]);const Me=async r=>{console.log("ðŸ‘¥ Loading members for group:",r);const s=await fetch(`${k}/api/groups/${r}/members`);if(s.ok){const n=await s.json();return console.log("ðŸ‘¥ Members loaded:",n.length,"members"),console.log("ðŸ‘¥ Member details:",n.map(i=>({user_id:i.user_id,username:i.users?.username,email:i.users?.email}))),Y(n),Ye(a?n.some(i=>i.user_id===a):!1),n}return console.error("ðŸ‘¥ Failed to load members:",s.status),[]},ar=async()=>{Te(null),fr(!0);try{console.log("ðŸ‘¤ Loading all users from:",`${k}/api/users`),console.log("ðŸ‘¤ Current user ID:",a);const r=await fetch(`${k}/api/users`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(console.log("ðŸ‘¤ Users response status:",r.status,r.statusText),console.log("ðŸ‘¤ Response headers:",Object.fromEntries(r.headers.entries())),r.ok){const s=await r.json();console.log("ðŸ‘¤ Total users loaded:",s.length),console.log("ðŸ‘¤ User details:",s.map(i=>({user_id:i.user_id,display_name:i.display_name,username:i.username,email:i.email})));const n=s.filter(i=>i.user_id!==a);console.log("ðŸ‘¤ Other users (excluding current):",n.length),Or(n),Te(null)}else{const s=await r.text();console.error("ðŸ‘¤ Failed to load users:",r.status,r.statusText),console.error("ðŸ‘¤ Error response:",s);const n=`Failed to load users: ${r.status} ${r.statusText}`;Te(n)}}catch(r){console.error("ðŸ‘¤ Failed to load users - Exception:",r),console.error("ðŸ‘¤ Error stack:",r.stack);const s=`Cannot connect to backend: ${r.message}

Make sure:
1. Backend is running (npm run dev)
2. You're on the same WiFi network
3. API_BASE is set to: ${k}`;Te(s)}finally{fr(!1)}},os=async({displayName:r})=>{kr(!0),vr("");try{const{data:{session:s}}=await N.auth.getSession(),n=s?.access_token;if(!n)throw new Error("Please log in again.");const i=await fetch(`${k}/api/users/profile`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({display_name:r})});if(!i.ok){const v=await i.json().catch(()=>({}));throw new Error(v.error||"Failed to update profile.")}const{profile:y}=await i.json();if(y){Sr(y);const v=sr(y,y.email||s?.user?.email,a);Dr(v)}De(!1),er(!1),Re({open:!0,message:"Profile updated!",severity:"success"}),u&&await Me(u.id),await ar()}catch(s){console.error("[Groups] Profile update failed:",s),vr(s.message||"Failed to update profile.")}finally{kr(!1)}},ns=()=>{De(!1),er(!0)},Mr=async()=>{const r=p.trim();if(!r||!E)return;if(!a){alert("Please log in to send messages."),l&&l("login");return}const{data:{session:s}}=await N.auth.getSession(),n=s?.access_token;if(!n){alert("Please log in to send messages."),l&&l("login");return}const i=`temp-${Date.now()}`,y={id:i,content:r,created_at:new Date().toISOString(),sender_id:a,receiver_id:E.user_id,sender:{user_id:a,display_name:be,username:be,avatar_url:null},optimistic:!0};le(ee=>[...ee,y]),w("");const v=`${k}/api/direct-messages`;try{const ee=new AbortController,ae=setTimeout(()=>ee.abort(),1e4);console.log("ðŸš€ Sending direct message to:",v),console.log("ðŸ“ Message content:",r),console.log("ðŸ‘¤ Sender ID:",a),console.log("ðŸ‘¤ Receiver ID:",E.user_id);const H=await fetch(v,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({sender_id:a,receiver_id:E.user_id,content:r}),signal:ee.signal});if(clearTimeout(ae),H.ok){console.log("âœ… Direct message sent successfully!");const oe=await H.json();le(q=>q.filter(re=>re.id!==i)),oe&&oe.id?O.onNewMessage(oe):setTimeout(async()=>{E?.user_id&&await nr(E.user_id)},500),ce(),w("")}else{const oe=await H.text();console.error("âŒ Server error response:",oe),le(q=>q.filter(re=>re.id!==i)),alert(`Failed to send direct message!

Status: ${H.status} ${H.statusText}
Error: ${oe}

API: ${v}

Make sure:
1. Backend is running
2. You're on the same WiFi
3. API is: ${k}`)}}catch(ee){le(ae=>ae.filter(H=>H.id!==i)),console.error("âŒ Send direct message error:",ee),alert(`Failed to send direct message!

Error: ${ee.message}

API: ${v}

This usually means:
1. Backend is not running
2. Wrong WiFi network
3. Firewall blocking connection

Current API: ${k}`)}},as=async r=>{console.log("ðŸ“‚ Opening group:",r.name,r.id),console.log("ðŸ“‚ Current messages state before clearing:",X.length),R(r),L([]),console.log("ðŸ“‚ Messages cleared, opening dialog"),G(!0),await Be(r.id);const s=await Me(r.id),n=a?s.some(i=>i.user_id===a):!1;a&&!n&&(await ir({group:r,silent:!0}),await Me(r.id),await Be(r.id))},ir=async({group:r=u,silent:s=!1}={})=>{const n=r;if(n)try{if(!a){s||(alert("Please log in to join groups."),l&&l("login"));return}const i=await fetch(`${k}/api/groups/${n.id}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a})});if(i.ok){await Me(n.id),Ye(!0),s||Re({open:!0,message:"Joined group!",severity:"success"});return}const v=(await i.json().catch(()=>({}))).error||"";if(typeof v=="string"&&v.toLowerCase().includes("already a member")){await Me(n.id),Ye(!0),s||Re({open:!0,message:"You are already in this group.",severity:"info"});return}s?console.error("Failed to join group silently:",v||"Unknown error"):alert(v||"Failed to join group")}catch(i){console.error("Failed to join group",i),s||alert("Failed to join group")}},is=t.useCallback(()=>{G(!1),R(null),L([])},[]),Ir=async(r=null,s=null)=>{const n=(r||p).trim();if(!n||!u||S)return;if(!xe){$e(!0);return}if(!a){I("Please log in to send messages."),l&&l("login");return}m(!0),I("");const{data:{session:i}}=await N.auth.getSession(),y=i?.access_token;if(!y){I("Please log in to send messages."),m(!1),l&&l("login");return}const v=`temp-${Date.now()}`,ee={id:v,content:n,created_at:new Date().toISOString(),user_id:a,users:{id:a,display_name:be,username:be,avatar_url:null},optimistic:!0};L(q=>[...q,ee]);const ae=p;w("");const H=W?.id||null;M(null);let oe;try{const q=new AbortController;oe=setTimeout(()=>q.abort(),1e4);const re=`${k}/api/groups/${u.id}/messages`;console.log("ðŸš€ Sending message to:",re),console.log("ðŸ“ Message content:",n),console.log("ðŸ‘¤ User ID:",a);const ye={content:ae.trim()||null,user_id:a,reply_to_id:H,attachments:s&&s.length>0?s:null},se=await fetch(re,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`},body:JSON.stringify(ye),signal:q.signal});if(clearTimeout(oe),console.log("ðŸ“¡ Response status:",se.status),console.log("ðŸ“¡ Response ok:",se.ok),se.ok){console.log("âœ… Message sent successfully!");const te=await se.json();console.log("ðŸ“¨ Response data:",te),L(Ee=>Ee.filter(Tr=>Tr.id!==v)),te&&te.id?(console.log("ðŸ“¨ Adding message from response:",te),j.onNewMessage(te)):(console.log("ðŸ“¨ No message in response, reloading..."),setTimeout(async()=>{},500)),We()}else{let te=null;try{te=await se.json()}catch{te=null}const Ee=te?.error||te?.hint||`Send failed (${se.status})`;if(console.error("âŒ Server error response:",Ee),I(Ee),w(ae),H){const Ar=(j.messages||[]).find($r=>$r.id===H||$r.raw?.id===H);Ar&&M(Ar)}}}catch(q){console.error("âŒ Error sending message:",q),L(ye=>ye.filter(se=>se.id!==v));let re="Failed to send message. Please try again.";if(q.name==="AbortError"?re="Request timed out. Please check your connection and try again.":q.message&&(re=q.message),I(re),w(ae),H){const ye=X.find(se=>se.id===H);ye&&M(ye)}}finally{m(!1)}},ls=async()=>{if(Ae)try{if(!a){alert("Please log in to report messages."),l&&l("login");return}const{data:{session:r}}=await N.auth.getSession(),s={"Content-Type":"application/json"};r?.access_token&&(s.Authorization=`Bearer ${r.access_token}`);const n=await fetch(`${k}/api/moderation/report`,{method:"POST",headers:s,body:JSON.stringify({message_id:Ae.id,reported_by:a,reason:xr,details:mr})});if(n.ok)alert("Report submitted. Thank you for helping keep our community safe."),Je(!1),qr(null),br("");else{const i=await n.json();alert(i.error||"Failed to submit report")}}catch(r){console.error("Failed to submit report",r),alert("Failed to submit report")}};t.useEffect(()=>{if(!u)return;const r=x.find(s=>s.id===u.id);r&&r!==u&&R(r)},[x,u,F]);const Pe=t.useMemo(()=>{if(!F||!Array.isArray(x))return[];if(x.length===0)return[];try{return[...x].sort((s,n)=>{if(!s||!n)return 0;const i=s?.last_message?.created_at||s?.created_at||0,y=n?.last_message?.created_at||n?.created_at||0;try{return new Date(y).getTime()-new Date(i).getTime()}catch{return 0}})}catch(r){return console.error("[Groups] Error sorting groups:",r),x}},[x,F]),cs=r=>{if(!r||!r.id)return null;try{const s=r?.last_message,n=s?.user?.display_name||s?.user?.username,i=s?`${n?`${n}: `:""}${ts(s?.content||"")}`:"No conversations yet.",y=ss(s?.created_at||r?.created_at);return e.jsxs(T,{variant:"outlined",onClick:()=>as(r),fullWidth:!0,sx:{justifyContent:"space-between",alignItems:"flex-start",textAlign:"left",p:2,borderRadius:3,borderColor:"rgba(124,179,66,0.4)",bgcolor:"rgba(255,255,255,0.05)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",color:"#CDDC39","&:hover":{bgcolor:"rgba(124,179,66,0.2)",borderColor:"rgba(124,179,66,0.6)"}},children:[e.jsxs(A,{spacing:.5,sx:{flex:1,pr:2},children:[e.jsx(d,{variant:"subtitle1",sx:{fontWeight:700,color:"#CDDC39"},children:r?.name||"Unnamed Group"}),e.jsx(d,{variant:"body2",sx:{color:"#9CCC65"},children:i}),e.jsxs(d,{variant:"caption",sx:{color:"#7CB342"},children:[r?.member_count||0," member",(r?.member_count||0)===1?"":"s"]})]}),e.jsx(d,{variant:"caption",sx:{color:"rgba(22,34,22,0.6)"},children:y})]},r.id)}catch(s){return console.error("[Groups] Error rendering group button:",s,r),null}};return!h&&u&&_?e.jsxs(c,{sx:{display:"flex",height:"100vh",overflow:"hidden",position:"relative"},children:[e.jsxs(c,{sx:{width:{xs:"100%",sm:"50%",md:"50%"},minWidth:{xs:"100%",sm:"400px"},flexShrink:0,borderRight:{xs:"none",sm:"1px solid rgba(255,255,255,0.08)"},display:"flex",flexDirection:"column",overflow:"hidden",backgroundColor:"transparent",backdropFilter:"blur(10px)"},children:[e.jsx(c,{sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.08)",flexShrink:0},children:e.jsx(d,{variant:"h6",sx:{fontWeight:700,color:"#CDDC39"},children:"Groups"})}),e.jsx($s,{groups:Pe,selectedGroupId:u?.id,onSelectGroup:r=>{R(r),G(!0)},isLoading:P})]}),e.jsxs(c,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",overflow:"hidden"},children:[!xe&&e.jsxs(Ie,{severity:"warning",icon:!1,sx:{background:"rgba(255,193,7,0.25)",color:"#CDDC39",border:"1px solid rgba(255,193,7,0.5)",flexShrink:0,m:1,mb:0},children:["By participating, you agree to our"," ",e.jsx(lr,{component:"button",onClick:()=>l&&l("guidelines"),sx:{fontWeight:700,color:"#fff",textDecoration:"underline"},children:"Community Guidelines"}),"."]}),e.jsx(Er,{messages:j.messages,pinnedMessages:j.pinnedMessages,isLoadingInitial:j.isLoadingInitial,isLoadingMore:j.isLoadingMore,hasMore:j.hasMore,onLoadMore:j.loadMore,scrollContainerRef:j.scrollContainerRef,scrollToBottomRef:j.scrollToBottomRef,onScroll:j.handleScroll,currentUserId:a,group:u,onBack:()=>{G(!1),R(null)},onSend:Ne&&xe?async(r,s,n)=>{!r?.trim()&&(!s||s.length===0)||!u||!a||(n&&M(n),await Ir(r,s))}:null,typingUsers:B.typingUsers||[]}),!Ne&&e.jsx(c,{sx:{p:2,textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.08)",flexShrink:0},children:e.jsx(T,{variant:"contained",onClick:()=>ir(),sx:{bgcolor:"rgba(124,179,66,0.9)",color:"#fff","&:hover":{bgcolor:"rgba(156,204,101,1)"}},children:"Join Group to Send Messages"})})]})]}):e.jsxs(c,{sx:{display:"flex",flexDirection:"column",height:"100vh",overflow:"hidden",position:"relative"},children:[e.jsx(c,{sx:{position:"absolute",inset:0,zIndex:0,background:`
            linear-gradient(135deg,
              rgba(10, 31, 10, 0.4) 0%,
              rgba(26, 58, 26, 0.5) 15%,
              rgba(45, 90, 45, 0.6) 30%,
              rgba(34, 139, 34, 0.5) 45%,
              rgba(45, 90, 45, 0.6) 60%,
              rgba(26, 58, 26, 0.5) 75%,
              rgba(10, 31, 10, 0.4) 100%
            ),
            radial-gradient(circle at 20% 30%, rgba(124, 179, 66, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 70%, rgba(34, 139, 34, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(45, 90, 45, 0.2) 0%, transparent 70%),
            linear-gradient(180deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 50, 0, 0.4) 100%)
          `,backgroundSize:"100% 100%, 150% 150%, 150% 150%, 200% 200%, 100% 100%",backgroundPosition:"center, 20% 30%, 80% 70%, 50% 50%, center",boxShadow:"inset 0 0 100px rgba(0, 0, 0, 0.3), inset 0 0 50px rgba(124, 179, 66, 0.1)","&::before":{content:'""',position:"absolute",inset:0,background:`url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E")`,opacity:.5,pointerEvents:"none"}}}),e.jsx(c,{sx:{flexShrink:0,position:"relative",zIndex:1},children:e.jsxs(c,{sx:{pt:"calc(env(safe-area-inset-top, 0px) + 8px)",pb:1.5,px:{xs:1.5,md:2}},children:[e.jsx(Ms,{open:Zr,email:Qe?.email||g?.email||"",initialDisplayName:Qe?.display_name||be,initialUsername:Qe?.username||"",saving:es,error:rs,onSave:os,onClose:ns}),b?e.jsx(_s,{title:"Groups",onBack:b}):e.jsx(T,{onClick:()=>window.history.back(),size:"small",variant:"contained",sx:{bgcolor:"rgba(124, 179, 66, 0.9)",color:"#fff",textTransform:"none",fontWeight:700,borderRadius:999,mb:2,boxShadow:"0 4px 12px rgba(124, 179, 66, 0.4)","&:hover":{bgcolor:"rgba(156, 204, 101, 1)",boxShadow:"0 6px 16px rgba(124, 179, 66, 0.6)",transform:"translateY(-2px)"}},children:"â† Back to Garden"}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:1.5},children:[e.jsx(c,{sx:{width:48,height:48,borderRadius:"50%",background:"transparent",border:"2px solid rgba(124, 179, 66, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 0 16px rgba(124, 179, 66, 0.4)",overflow:"hidden",flexShrink:0},children:e.jsx("img",{src:"/hero.png?v=13",alt:"StrainSpotter",style:{width:"100%",height:"100%",objectFit:"cover"}})}),e.jsx(d,{variant:"h6",sx:{fontWeight:700,fontSize:"1.1rem",color:"#CDDC39"},children:"Groups & Chat"})]}),e.jsxs(A,{direction:"row",spacing:1,sx:{mb:1.5},alignItems:"center",children:[e.jsxs(d,{variant:"body2",sx:{color:"#9CCC65",flex:1},children:["Signed in as ",be]}),e.jsx(T,{size:"small",variant:"outlined",onClick:()=>{er(!1),De(!0)},sx:{color:"#CDDC39",borderColor:"rgba(124,179,66,0.4)",textTransform:"none",fontWeight:600,"&:hover":{borderColor:"rgba(124,179,66,0.7)",bgcolor:"rgba(124,179,66,0.15)"}},children:"Edit Profile"})]})]})}),e.jsx(c,{sx:{flex:1,minHeight:0,overflowY:"auto",WebkitOverflowScrolling:"touch",position:"relative",zIndex:1},children:e.jsx(c,{sx:{px:{xs:1.5,md:2},py:2,pb:"calc(env(safe-area-inset-bottom, 0px) + 80px)",width:"100%"},children:e.jsxs(fs,{sx:{bgcolor:"rgba(255,255,255,0.08)",color:"#CDDC39",boxShadow:"0 12px 30px rgba(0,0,0,0.4)",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",borderRadius:3,border:"1px solid rgba(124,179,66,0.3)"},children:[e.jsxs(xs,{value:V,onChange:(r,s)=>we(s),sx:{borderBottom:"1px solid rgba(124,179,66,0.3)","& .MuiTab-root":{color:"#9CCC65","&.Mui-selected":{color:"#CDDC39"}},"& .MuiTabs-indicator":{backgroundColor:"#CDDC39"}},children:[e.jsx(Fr,{icon:e.jsx(pr,{}),label:"Groups",iconPosition:"start"}),e.jsx(Fr,{icon:e.jsx(dr,{badgeContent:pe.reduce((r,s)=>r+(s.unread_count||0),0),color:"error",sx:{"& .MuiBadge-badge":{bgcolor:"#FF5252",color:"#fff",fontWeight:700,fontSize:"0.65rem",minWidth:"18px",height:"18px"}},children:e.jsx(ms,{})}),label:"Direct Messages",iconPosition:"start"})]}),e.jsxs(bs,{sx:{p:2},children:[V===0&&e.jsxs(A,{spacing:1.5,children:[e.jsx(d,{variant:"caption",sx:{mb:.5,color:"#9CCC65",fontSize:"0.75rem"},children:a?"Tap a group to open the chat.":"Sign in to join groups."}),!a&&e.jsx(T,{variant:"contained",color:"primary",fullWidth:!0,onClick:()=>l&&l("login"),sx:{mb:2},children:"Sign In to Continue"}),P?e.jsx(c,{sx:{textAlign:"center",py:3},children:e.jsx(d,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)"},children:"Loading groups..."})}):!Array.isArray(Pe)||Pe.length===0?e.jsxs(A,{spacing:1.5,sx:{py:2},children:[e.jsx(d,{variant:"body2",sx:{color:"#9CCC65",textAlign:"center"},children:x.length===0&&!P?"No groups available. Make sure the backend is running and try refreshing.":"No groups match the filter."}),e.jsx(T,{variant:"outlined",onClick:()=>{U(!0),We()},sx:{borderColor:"rgba(124,179,66,0.4)",color:"#CDDC39","&:hover":{borderColor:"rgba(124,179,66,0.6)",bgcolor:"rgba(124,179,66,0.1)"}},children:"Refresh Groups"})]}):e.jsx(A,{spacing:1.5,children:Pe.filter(r=>r&&r.id).map(cs)})]}),V===1&&e.jsxs(A,{spacing:1.5,children:[e.jsx(d,{variant:"caption",sx:{mb:.5,color:"#9CCC65",fontSize:"0.75rem"},children:a?"Start a private conversation with any user.":"Sign in to send direct messages."}),!a&&e.jsx(T,{variant:"contained",color:"primary",fullWidth:!0,onClick:()=>l&&l("login"),sx:{mb:2},children:"Sign In to Continue"}),a&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:"small",value:ke,onChange:r=>Hr(r.target.value),placeholder:"Search by name",variant:"outlined",fullWidth:!0,sx:{"& .MuiInputBase-root":{bgcolor:"rgba(255,255,255,0.05)",borderRadius:2,border:"1px solid rgba(124,179,66,0.3)",color:"#CDDC39"},mb:2}}),e.jsxs(A,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:{xs:"stretch",sm:"center"},sx:{mb:1},children:[e.jsx(d,{variant:"subtitle2",sx:{color:"#CDDC39",fontWeight:700},children:"Direct Messages"}),e.jsxs(ys,{color:"success",exclusive:!0,value:ve,onChange:(r,s)=>s&&Nr(s),size:"small",sx:{borderRadius:999,"& .MuiToggleButton-root":{color:"#9CCC65",borderColor:"rgba(124,179,66,0.3)",textTransform:"none",fontSize:"0.8rem"},"& .Mui-selected":{color:"#0c220f",backgroundColor:"rgba(124,179,66,0.7) !important"}},children:[e.jsx(Wr,{value:"recent",children:"Recent"}),e.jsx(Wr,{value:"all",children:"All Users"})]}),e.jsx(T,{size:"small",onClick:ar,disabled:fe,variant:"outlined",sx:{color:"#CDDC39",borderColor:"rgba(124,179,66,0.4)","&:hover":{borderColor:"rgba(124,179,66,0.6)",bgcolor:"rgba(124,179,66,0.1)"}},children:fe?"Loading...":"Refresh"})]}),Se&&e.jsx(d,{variant:"body2",sx:{color:"#ff8a80",fontWeight:500,mb:1},children:Se}),fe&&e.jsx(d,{variant:"body2",sx:{color:"#9CCC65"},children:"Loading users..."}),ve==="recent"&&Xe.length>0&&e.jsxs(c,{sx:{mb:3},children:[e.jsx(d,{variant:"subtitle2",sx:{color:"#CDDC39",fontWeight:700,mb:1.5,display:"flex",alignItems:"center",gap:1},children:"ðŸ’¬ Recent Chats"}),e.jsx(A,{spacing:1,children:Xe.map(r=>e.jsx(T,{variant:"outlined",onClick:()=>_e(r.user),fullWidth:!0,sx:{justifyContent:"flex-start",textAlign:"left",p:1.5,borderRadius:2,borderColor:"rgba(124,179,66,0.6)",bgcolor:"rgba(124,179,66,0.15)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",color:"#CDDC39","&:hover":{bgcolor:"rgba(124,179,66,0.25)",borderColor:"rgba(124,179,66,0.8)"}},children:e.jsxs(A,{direction:"row",spacing:1.5,alignItems:"center",sx:{width:"100%"},children:[e.jsx(dr,{badgeContent:r.unread_count||0,color:"error",sx:{"& .MuiBadge-badge":{bgcolor:"#FF5252",color:"#fff",fontWeight:700}},children:e.jsx(Ce,{sx:{bgcolor:"rgba(124,179,66,0.5)",color:"#0c220f"},children:(r.user.username||"U").slice(0,2).toUpperCase()})}),e.jsxs(c,{sx:{flex:1,minWidth:0},children:[e.jsx(d,{variant:"subtitle2",sx:{fontWeight:700,color:"#CDDC39"},children:r.user.display_name||r.user.username||"User"}),e.jsx(d,{variant:"caption",sx:{color:"#9CCC65",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block"},children:r.last_message?.content||"No messages yet"})]})]})},r.user.user_id))})]}),ve==="recent"&&!fe&&!Se&&Xe.length===0&&e.jsx(d,{variant:"body2",sx:{color:"#9CCC65"},children:"No recent chats yet. Switch to â€œAll Usersâ€ to start a new conversation."}),ve==="all"&&!fe&&!Se&&Ve.length===0&&e.jsx(d,{variant:"body2",sx:{color:"#9CCC65"},children:"No other users found. Click Refresh to try again."}),ve==="all"&&!fe&&!Se&&Ve.length>0&&e.jsxs(c,{children:[e.jsx(d,{variant:"subtitle2",sx:{color:"#9CCC65",fontWeight:700,mb:1.5,display:"flex",alignItems:"center",gap:1},children:"ðŸ‘¥ All Users"}),e.jsx(A,{spacing:1,children:Ve.map(r=>e.jsx(T,{variant:"outlined",onClick:()=>_e(r),fullWidth:!0,sx:{justifyContent:"flex-start",textAlign:"left",p:1.5,borderRadius:2,borderColor:"rgba(124,179,66,0.4)",bgcolor:"rgba(255,255,255,0.05)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",color:"#CDDC39","&:hover":{bgcolor:"rgba(124,179,66,0.2)",borderColor:"rgba(124,179,66,0.6)"}},children:e.jsxs(A,{direction:"row",spacing:1.5,alignItems:"center",children:[e.jsx(Ce,{sx:{bgcolor:"rgba(124,179,66,0.35)",color:"#0c220f"},children:(r.display_name||r.username||"U").slice(0,2).toUpperCase()}),e.jsxs(c,{children:[e.jsx(d,{variant:"subtitle2",sx:{fontWeight:700,color:"#CDDC39"},children:r.display_name||r.username||"User"}),e.jsx(d,{variant:"caption",sx:{color:"#9CCC65"},children:"Click to chat"})]})]})},r.user_id))})]})]})]})]})]})})}),_&&u&&e.jsxs(c,{sx:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,display:"flex",flexDirection:"column",bgcolor:"#0a0f0a",backdropFilter:"blur(20px)"},children:[e.jsx(ur,{group:u,memberCount:K.length,onBack:is,isMobile:h,typingUsers:B.typingUsers}),e.jsxs(c,{sx:{flex:1,minHeight:0,display:"flex",flexDirection:"column",overflow:"hidden"},children:[!xe&&e.jsxs(Ie,{severity:"warning",icon:!1,sx:{background:"rgba(255,193,7,0.25)",color:"#CDDC39",border:"1px solid rgba(255,193,7,0.5)",flexShrink:0,m:1,mb:0},children:["By participating, you agree to our"," ",e.jsx(lr,{component:"button",onClick:()=>l&&l("guidelines"),sx:{fontWeight:700,color:"#fff",textDecoration:"underline"},children:"Community Guidelines"}),"."]}),j.error?e.jsx(c,{sx:{p:2,textAlign:"center"},children:e.jsx(Ie,{severity:"info",sx:{bgcolor:"rgba(124, 179, 66, 0.15)",color:"#fff",border:"1px solid rgba(124, 179, 66, 0.3)"},children:e.jsx(d,{variant:"body2",sx:{color:"#e0e0e0"},children:"Chat is having trouble loading messages right now. You can still see groups and try again later."})})}):e.jsx(Er,{messages:j.messages,pinnedMessages:j.pinnedMessages,isLoadingInitial:j.isLoadingInitial,isLoadingMore:j.isLoadingMore,hasMore:j.hasMore,onLoadMore:j.loadMore,scrollContainerRef:j.scrollContainerRef,scrollToBottomRef:j.scrollToBottomRef,onScroll:j.handleScroll,currentUserId:a})]}),Ne?e.jsx(gr,{value:p,onChange:w,onSend:(r,s)=>{Ir(r,s)},disabled:S||!xe,sending:S,placeholder:xe?"Type a messageâ€¦":"Accept guidelines to send messages",replyToMessage:W,onCancelReply:()=>M(null),notifyTyping:B.notifyTyping,scope:"group",channelId:u?.id||null}):e.jsx(c,{sx:{p:2,textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.08)"},children:e.jsx(T,{variant:"contained",onClick:()=>ir(),sx:{bgcolor:"rgba(124,179,66,0.9)",color:"#fff","&:hover":{bgcolor:"rgba(156,204,101,1)"}},children:"Join Group to Send Messages"})})]}),e.jsxs(ze,{open:ie,onClose:()=>he(!1),fullWidth:!0,fullScreen:!0,PaperProps:{sx:{background:"rgba(0, 0, 0, 0.3)",backdropFilter:"blur(30px)",WebkitBackdropFilter:"blur(30px)",m:0,maxHeight:"100vh",display:"flex",flexDirection:"column",border:"1px solid rgba(124,179,66,0.3)"}},children:[e.jsxs(Ue,{sx:{borderBottom:"2px solid rgba(124,179,66,0.4)",background:"rgba(124,179,66,0.1)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5,pt:"calc(env(safe-area-inset-top, 0px) + 8px)",minHeight:44,maxHeight:44,boxShadow:"0 2px 8px rgba(0,0,0,0.3)"},children:[e.jsxs(A,{direction:"row",spacing:1.5,alignItems:"center",sx:{flex:1,minWidth:0},children:[e.jsx(T,{startIcon:e.jsx(Cs,{fontSize:"small"}),onClick:()=>he(!1),sx:{color:"#CDDC39",textTransform:"none",fontWeight:600,"&:hover":{bgcolor:"rgba(124,179,66,0.2)"}},children:"Back"}),e.jsx(Ce,{sx:{bgcolor:"rgba(124,179,66,0.35)",color:"#0c220f"},children:(E?.username||E?.display_name||"U").slice(0,2).toUpperCase()}),e.jsx(d,{variant:"h6",noWrap:!0,sx:{fontWeight:700,color:"#CDDC39",textShadow:"0 2px 4px rgba(0,0,0,0.3)"},children:E?.display_name||E?.username||"User"})]}),e.jsx(T,{size:"small",onClick:()=>he(!1),sx:{color:"#CDDC39","&:hover":{bgcolor:"rgba(124,179,66,0.2)"}},children:"Close"})]}),e.jsx(Ge,{sx:{flex:1,minHeight:0,p:0,display:"flex",flexDirection:"column",overflow:"hidden",background:"transparent"},children:e.jsxs(A,{spacing:2,sx:{p:2,flex:1,display:"flex",flexDirection:"column",minHeight:0},children:[e.jsx(Ie,{severity:"info",sx:{flexShrink:0,bgcolor:"rgba(124,179,66,0.08)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",color:"#CDDC39",border:"1px solid rgba(124,179,66,0.3)","& .MuiAlert-icon":{color:"#CDDC39"}},children:e.jsx(d,{variant:"caption",sx:{fontSize:"0.75rem"},children:"ðŸ’¬ Only the most recent 500 messages are shown. Older messages are automatically archived."})}),e.jsxs(c,{ref:O.scrollContainerRef,onScroll:O.handleScroll,sx:{flex:1,minHeight:0,overflowY:"auto",WebkitOverflowScrolling:"touch",border:"2px solid rgba(124,179,66,0.4)",borderRadius:2,p:2,background:"transparent",backdropFilter:"blur(15px)",WebkitBackdropFilter:"blur(15px)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.3)"},children:[O.hasMore&&e.jsx(c,{sx:{mb:2,display:"flex",justifyContent:"center"},children:e.jsx(T,{onClick:O.loadMore,disabled:O.isLoadingMore,variant:"outlined",size:"small",sx:{color:"#9CCC65",borderColor:"rgba(124,179,66,0.4)","&:hover":{borderColor:"rgba(124,179,66,0.6)",bgcolor:"rgba(124,179,66,0.1)"}},children:O.isLoadingMore?"Loadingâ€¦":"Load earlier messages"})}),O.isLoadingInitial&&e.jsx(c,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(d,{variant:"body2",sx:{color:"#9CCC65"},children:"Loading messages..."})}),e.jsx(js,{sx:{p:0},children:!O.isLoadingInitial&&O.messages.length===0?e.jsx(Br,{children:e.jsx(ws,{secondary:e.jsx(d,{variant:"body2",sx:{color:"#9CCC65"},children:"Start a conversation! Say hello or ask a question."})})}):O.messages.map((r,s)=>{const n=r.raw||r,i=(n.sender_id||n.user_id)===a,y=i?"You":r.sender?.display_name||r.sender?.username||E?.display_name||E?.username||"User",v=y.slice(0,2).toUpperCase();return e.jsxs(Br,{sx:{flexDirection:i?"row-reverse":"row",alignItems:"flex-start",gap:1,mb:1.5},children:[e.jsx(Ss,{sx:{minWidth:"auto"},children:e.jsx(Ce,{sx:{bgcolor:i?"rgba(124,179,66,0.5)":"rgba(124,179,66,0.35)",color:"#0c220f",width:32,height:32,fontSize:"0.875rem"},children:v})}),e.jsxs(c,{sx:{maxWidth:"70%",bgcolor:i?"rgba(124,179,66,0.2)":"rgba(255,255,255,0.05)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",border:`1px solid ${i?"rgba(124,179,66,0.4)":"rgba(124,179,66,0.3)"}`,borderRadius:2,p:1.5,boxShadow:"0 2px 8px rgba(0,0,0,0.2)"},children:[e.jsx(d,{variant:"body2",sx:{color:"#CDDC39",wordBreak:"break-word"},children:n.body||n.text||n.content}),e.jsxs(d,{variant:"caption",sx:{color:"#9CCC65",display:"block",mt:.5},children:[y," â€¢ ",new Date(n.created_at||n.createdAt).toLocaleString(),n.optimistic?" â€¢ sendingâ€¦":""]})]})]},n.id||s)})}),e.jsx("div",{ref:O.scrollToBottomRef})]}),e.jsxs(A,{direction:"row",spacing:1,sx:{flexShrink:0},children:[e.jsx(ue,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:p,onChange:r=>w(r.target.value),onKeyDown:r=>r.key==="Enter"&&!r.shiftKey&&Mr(),multiline:!0,maxRows:3,sx:{"& .MuiInputBase-root":{bgcolor:"rgba(255,255,255,0.05)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",border:"1px solid rgba(124,179,66,0.4)",borderRadius:2,"&:hover":{border:"1px solid rgba(124,179,66,0.6)"},"&.Mui-focused":{border:"1px solid rgba(205,220,57,0.8)",boxShadow:"0 0 8px rgba(124,179,66,0.4)"}},"& .MuiInputBase-input":{color:"#CDDC39"},"& .MuiInputBase-input::placeholder":{color:"#9CCC65",opacity:.7}}}),e.jsx(T,{variant:"contained",onClick:Mr,sx:{minWidth:"80px",bgcolor:"rgba(124,179,66,0.9)",color:"#fff",fontWeight:700,boxShadow:"0 4px 12px rgba(124,179,66,0.4)","&:hover":{bgcolor:"rgba(156,204,101,1)",boxShadow:"0 6px 16px rgba(124,179,66,0.6)"}},children:"Send"})]})]})})]}),e.jsxs(ze,{open:Jr,onClose:()=>Je(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ue,{sx:{bgcolor:"rgba(255,255,255,0.7)",boxShadow:"0 8px 32px 0 rgba(31, 38, 135, 0.37)",backdropFilter:"blur(12px)",borderRadius:4,border:"1px solid rgba(255,255,255,0.18)"},children:"Report Message"}),e.jsxs(Ge,{sx:{bgcolor:"rgba(255,255,255,0.7)",boxShadow:"0 8px 32px 0 rgba(31, 38, 135, 0.37)",backdropFilter:"blur(12px)",borderRadius:4,border:"1px solid rgba(255,255,255,0.18)"},children:[Ae&&e.jsxs(c,{sx:{mb:2},children:[e.jsx(d,{variant:"subtitle2",color:"text.secondary",children:"Message:"}),e.jsx(d,{variant:"body2",sx:{p:1,bgcolor:"grey.100",borderRadius:1},children:Ae.content})]}),e.jsxs(A,{spacing:2,sx:{mt:2},children:[e.jsxs(ue,{select:!0,label:"Reason",value:xr,onChange:r=>Kr(r.target.value),fullWidth:!0,SelectProps:{native:!0},children:[e.jsx("option",{value:"inappropriate",children:"Inappropriate content"}),e.jsx("option",{value:"harassment",children:"Harassment or bullying"}),e.jsx("option",{value:"spam",children:"Spam or advertising"}),e.jsx("option",{value:"hate",children:"Hate speech"}),e.jsx("option",{value:"threats",children:"Threats or violence"}),e.jsx("option",{value:"other",children:"Other"})]}),e.jsx(ue,{label:"Additional details (optional)",multiline:!0,rows:3,fullWidth:!0,value:mr,onChange:r=>br(r.target.value),placeholder:"Provide any additional context..."})]})]}),e.jsxs(cr,{children:[e.jsx(T,{onClick:()=>Je(!1),children:"Cancel"}),e.jsx(T,{onClick:ls,variant:"contained",color:"error",children:"Submit Report"})]})]}),e.jsxs(ze,{open:Xr,onClose:()=>$e(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ue,{children:"Agree to Community Guidelines"}),e.jsx(Ge,{children:e.jsxs(A,{spacing:2,sx:{mt:1},children:[e.jsx(d,{variant:"body2",children:"To keep conversations helpful and safe, please agree to follow our community rules (no solicitations, no personal contact info, no harassment, obey local laws)."}),e.jsx(lr,{component:"button",onClick:()=>l&&l("guidelines"),sx:{alignSelf:"flex-start"},children:"View full Community Guidelines"}),e.jsx(ks,{control:e.jsx(vs,{checked:yr,onChange:r=>Vr(r.target.checked)}),label:"I agree to follow the Community Guidelines"})]})}),e.jsxs(cr,{children:[e.jsx(T,{onClick:()=>$e(!1),children:"Cancel"}),e.jsx(T,{onClick:()=>{localStorage.setItem(Ke,"true"),Cr(!0),$e(!1)},variant:"contained",disabled:!yr,children:"Accept & Continue"})]})]}),e.jsx(Ds,{open:qe.open,autoHideDuration:4e3,onClose:jr,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(Ie,{onClose:jr,severity:qe.severity,sx:{width:"100%"},children:qe.message})})]})}export{Hs as default};
