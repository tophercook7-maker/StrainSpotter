name: Build Mobile Apps

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - android
          - ios
          - both
      profile:
        description: 'Build profile'
        required: true
        type: choice
        default: 'production'
        options:
          - production
          - preview
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: StrainSpotterMobile/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: StrainSpotterMobile
        run: npm ci

      - name: Build Android APK
        working-directory: StrainSpotterMobile
        run: |
          PROFILE="${{ github.event.inputs.profile || 'production' }}"
          eas build --platform android --profile $PROFILE --non-interactive --no-wait
          
      - name: Download APK
        working-directory: StrainSpotterMobile
        run: |
          # Wait for build to complete and download
          BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
          echo "Waiting for build $BUILD_ID to complete..."
          
          while true; do
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "finished" ]; then
              echo "Build completed successfully!"
              ARTIFACT_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl')
              wget -O StrainSpotter.apk "$ARTIFACT_URL"
              break
            elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
          done

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: StrainSpotter-Android
          path: StrainSpotterMobile/StrainSpotter.apk
          retention-days: 30

  build-ios:
    name: Build iOS IPA
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: StrainSpotterMobile/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: StrainSpotterMobile
        run: npm ci

      - name: Build iOS IPA
        working-directory: StrainSpotterMobile
        run: |
          PROFILE="${{ github.event.inputs.profile || 'production' }}"
          eas build --platform ios --profile $PROFILE --non-interactive --no-wait

      - name: Download IPA
        working-directory: StrainSpotterMobile
        run: |
          # Wait for build to complete and download
          BUILD_ID=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].id')
          echo "Waiting for build $BUILD_ID to complete..."
          
          while true; do
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "finished" ]; then
              echo "Build completed successfully!"
              ARTIFACT_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl')
              wget -O StrainSpotter.ipa "$ARTIFACT_URL"
              break
            elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
          done

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: StrainSpotter-iOS
          path: StrainSpotterMobile/StrainSpotter.ipa
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: StrainSpotter-Android
          path: ./artifacts

      - name: Download iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: StrainSpotter-iOS
          path: ./artifacts

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: StrainSpotter v${{ steps.version.outputs.VERSION }}
          body: |
            # StrainSpotter v${{ steps.version.outputs.VERSION }}
            
            ## ðŸ“± Download Installers
            
            ### Android
            - **StrainSpotter.apk** - Direct install on Android devices
            - Enable "Install from Unknown Sources" in your Android settings
            - Download and tap to install
            
            ### iOS
            - **StrainSpotter.ipa** - For TestFlight or direct install
            - Requires Apple Developer account for installation
            - Use TestFlight for easier distribution
            
            ## ðŸŒ¿ Features
            - AI-powered cannabis strain identification
            - 35,000+ strain database
            - Scan history and tracking
            - Community features
            - Grow coach and tips
            
            ## ðŸ“‹ Requirements
            - Android 8.0+ or iOS 13.0+
            - Camera permission for scanning
            - Internet connection
            
            ---
            
            Built with Expo EAS Build
          files: |
            ./artifacts/StrainSpotter.apk
            ./artifacts/StrainSpotter.ipa
          draft: false
          prerelease: false

